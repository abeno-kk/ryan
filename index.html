<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸‰å¹´ç´šï½œçœŸåˆ†æ•¸èˆ‡å‡åˆ†æ•¸ ç·´ç¿’</title>
  <style>
    :root{--bg:#f6f8fb;--card:#ffffff;--text:#222;--muted:#667085;--brand:#4f46e5;--good:#16a34a;--bad:#dc2626}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:24px auto;padding:16px}
    .title{font-weight:800;margin:0 0 8px}
    .sub{color:var(--muted);margin:0 0 18px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:18px}
    .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:#eef2ff;color:#3730a3}
    .btn[aria-current="true"],.btn.primary{background:var(--brand);color:#fff}
    .btn.small{padding:6px 10px;font-weight:600}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .big{font-size:40px;font-weight:900}
    .muted{color:var(--muted)}
    .mono{font-variant-numeric:tabular-nums}
    .frac{display:inline-grid;grid-template-rows:auto auto;line-height:1}
    .frac .n{border-bottom:2px solid #111;text-align:center}
    .frac .d{text-align:center}
    .input{display:inline-flex;gap:6px;align-items:end}
    input[type=number]{width:86px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;font-size:18px}
    .progress{height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#4f46e5)}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-size:12px}
    /* è¦–è¦ºåŒ–å€åŸŸ */
    .viz{margin-top:16px;border-top:1px dashed #e5e7eb;padding-top:12px}
    .viz-title{font-weight:800;margin-bottom:8px}
    .viz-row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .viz-circle{width:70px;height:70px;border-radius:50%;background:#4f46e5;box-shadow:inset 0 0 0 2px rgba(0,0,0,.12)}
    .viz-item{text-align:center}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800}
    .tag.good{background:#dcfce7;color:#166534}
    .tag.warn{background:#fee2e2;color:#991b1b}
    /* é¡Œç›®èªªæ˜ */
    .hint{background:#f4f3ff;border:1px solid #e5e7ff;color:#3730a3;padding:10px 12px;border-radius:10px;margin:10px 0;font-weight:700}
    /* æµ®å‹•ç´€éŒ„éµèˆ‡é¢æ¿ */
    .fab{position:fixed;right:16px;bottom:16px;background:var(--brand);color:#fff;border:none;border-radius:999px;padding:12px 16px;font-weight:800;box-shadow:0 8px 20px rgba(79,70,229,.35);z-index:50}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:40}
    .modal .panel{width:min(92vw,480px);max-height:80vh;overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">ä¸‰å¹´ç´šï½œçœŸåˆ†æ•¸èˆ‡å‡åˆ†æ•¸ ç·´ç¿’</h1>
    <p class="sub">æ¯å¤©10é¡Œï¼Œé¡Œç›®ä¸é‡è¤‡ï¼›å…ˆçœ‹æ‡‚çœŸåˆ†æ•¸ã€å‡åˆ†æ•¸ã€å¸¶åˆ†æ•¸ï¼Œå†é–‹å§‹é—–é—œï¼</p>

    <!-- å‡ºé¡Œå€ï¼ˆå«è¦–è¦ºåŒ–ï¼‰ -->
    <section class="card" id="trainer">
      <div class="row" id="modebar"></div>
      <div class="row" id="viewbar" style="margin:8px 0 4px"></div>
      <div id="qbox"></div>

      <!-- å…§åµŒè¦–è¦ºåŒ–ï¼šè·Ÿé¡Œç›®åŒæ­¥ -->
      <div class="viz" id="viz">
        <div class="viz-title">çœ‹åœ–å°±æ‡‚</div>
        <div id="vizBadge" class="tag">â€”</div>
        <div id="vizCircles" class="viz-row" style="margin-top:8px"></div>
        <ul class="muted" style="margin:8px 0 0 18px">
          <li>åˆ†æ¯ï¼åˆ‡å¹¾å¡Šï¼ˆåˆ‡æ³•ï¼‰ï¼åˆ†å­ï¼æ‹¿å¹¾å¡Šï¼ˆä»½æ•¸ï¼‰</li>
          <li>åˆ†å­ < åˆ†æ¯ â†’ çœŸåˆ†æ•¸ï¼›åˆ†å­ > åˆ†æ¯ â†’ å‡åˆ†æ•¸ï¼›åˆ†å­ï¼åˆ†æ¯ â†’ æ•´æ•¸1</li>
        </ul>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:12px">
        <div class="row">
          <button class="btn small" id="rerollBtn">éš¨æ©Ÿä¸€é¡Œ</button>
          <button class="btn small" id="skipBtn">è·³éä¸€é¡Œ</button>
          <span class="pill mono" id="seedInfo"></span>
        </div>
        <div style="flex:1;margin-left:16px">
          <div class="progress"><span id="bar" style="width:0%"></span></div>
          <div class="row" style="justify-content:space-between;margin-top:6px">
            <span class="muted mono">ç¬¬ <b id="idx">0</b> / <b id="total">10</b> é¡Œ</span>
            <span class="muted mono">å¾—åˆ† <b id="score">0</b></span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- æµ®å‹•æŒ‰éˆ•ï¼šé–‹å•Ÿä»Šæ—¥å­¸ç¿’ç´€éŒ„ -->
  <button class="fab" id="openLog">å­¸ç¿’ç´€éŒ„</button>
  <div class="modal" id="logModal" aria-hidden="true">
    <div class="panel card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">ä»Šå¤©çš„å­¸ç¿’ç´€éŒ„</h3>
        <button class="btn small" id="closeLog">é—œé–‰</button>
      </div>
      <div class="mono muted" id="hist"></div>
    </div>
  </div>

  <script>
    /******** å·¥å…· ********/
    function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return ()=>{h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^h>>>16)>>>0;};}
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
    function seededRand(seedStr){const seed=xmur3(seedStr)();return mulberry32(seed)}
    function todaySeed(){const d=new Date();const y=d.getFullYear(),m=(d.getMonth()+1+"").padStart(2,'0'),day=(d.getDate()+"").padStart(2,'0');return `${y}${m}${day}`}

    /******** ç‹€æ…‹ ********/
    const MODES=[
      {key:'judge',name:'åˆ¤æ–·çœŸï¼å‡åˆ†æ•¸'},
      {key:'imp2mix',name:'å‡åˆ†æ•¸â†’å¸¶åˆ†æ•¸'},
      {key:'mix2imp',name:'å¸¶åˆ†æ•¸â†’å‡åˆ†æ•¸'},
      {key:'visual',name:'çœ‹åœ–å¯«åˆ†æ•¸'}
    ];
    const state={seed:todaySeed(),rng:null,count:10,maxDen:12,idx:0,score:0,used:new Set(),todays:[],modeSel:'judge',historyKey:'',mistakes:[],view:'practice',practiceHint:false};

    /******** åŸºæœ¬è¨ˆç®— ********/
    function pickInt(min,max){return Math.floor(state.rng()*(max-min+1))+min}
    function genFraction({proper}){let d=pickInt(4,state.maxDen);let n;if(proper===true){n=pickInt(1,d-1)}else if(proper===false){n=pickInt(d,d*2)}else{n=pickInt(1,d*2-1);if(n===d)n++}return [n,d]}
    function toMixed(n,d){const whole=Math.floor(n/d);return {whole,n:n%d,d}}
    function makeFracSpan(n,d){return `<span class="frac"><span class="n">${n}</span><span class="d">${d}</span></span>`}
    function drawPieSVG(parts,filled){const R=36,cx=40,cy=40,ang=2*Math.PI/parts;let paths='';for(let i=0;i<filled;i++){const a0=-Math.PI/2+i*ang,a1=a0+ang,x1=cx+R*Math.cos(a0),y1=cy+R*Math.sin(a0),x2=cx+R*Math.cos(a1),y2=cy+R*Math.sin(a1);paths+=`<path d="M ${cx} ${cy} L ${x1} ${y1} A ${R} ${R} 0 0 1 ${x2} ${y2} Z" fill="#60a5fa"></path>`}return `<svg viewBox="0 0 80 80" width="80" height="80"><circle cx="40" cy="40" r="36" fill="#e5e7eb"></circle>${paths}</svg>`}

    /******** è¦–è¦ºåŒ–ï¼ˆå…§åµŒï¼‰ ********/
    function renderInlineVizByFrac(n,d,showAnswer){
      const badge=document.getElementById('vizBadge');
      const box=document.getElementById('vizCircles');
      box.innerHTML='';
      const {whole,n:rem}=toMixed(n,d);
      // ç·´ç¿’æ¨¡å¼é è¨­ä¸é€éœ²ç­”æ¡ˆ
      if(!showAnswer){
        badge.textContent='éœ€è¦æç¤ºï¼Ÿ';
        badge.className='tag';
        // åªç•«åœ–ï¼Œä¸é¡¯ç¤ºæ•¸å­—
        for(let i=0;i<whole;i++){
          const item=document.createElement('div');item.className='viz-item';item.innerHTML=`<div class="viz-circle"></div>`;box.appendChild(item);
        }
        if(rem>0||whole===0){
          const item=document.createElement('div');item.className='viz-item';item.innerHTML=`<div>${drawPieSVG(d,rem||n)}</div>`;box.appendChild(item);
        }
        return;
      }
      // æ•™å­¸æˆ–é–‹å•Ÿæç¤º â†’ é¡¯ç¤ºå®Œæ•´è§£é‡‹
      if(n<d){badge.textContent='çœŸåˆ†æ•¸';badge.className='tag good'}
      else if(n===d){badge.textContent='æ•´æ•¸ 1';badge.className='tag good'}
      else{badge.textContent=`å‡åˆ†æ•¸ï¼ˆ= ${whole} åˆ ${rem}/${d}ï¼‰`;badge.className='tag warn'}
      if(whole===0 && rem===0){
        const item=document.createElement('div');item.className='viz-item';item.innerHTML=`<div class="viz-circle" style="background:#e5e7eb"></div><div class="muted" style="text-align:center">0</div>`;box.appendChild(item);return;
      }
      for(let i=0;i<whole;i++){
        const item=document.createElement('div');item.className='viz-item';item.innerHTML=`<div class="viz-circle"></div><div class="muted" style="text-align:center">å®Œæ•´</div>`;box.appendChild(item);
      }
      if(rem>0){
        const item=document.createElement('div');item.className='viz-item';item.innerHTML=`<div>${drawPieSVG(d,rem)}</div><div class="muted" style="text-align:center">${rem}/${d}</div>`;box.appendChild(item);
      }
    }

    /******** é¡Œåº« ********/
    function genQByType(m){
      if(m==='judge'){const proper=state.rng()>0.5;const [n,d]=genFraction({proper});return {q:{type:'judge',n,d,proper},key:`J:${n}/${d}`}}
      if(m==='imp2mix'){const [n,d]=genFraction({proper:false});return {q:{type:'imp2mix',n,d},key:`I2M:${n}/${d}`}}
      if(m==='mix2imp'){const d=pickInt(4,state.maxDen),whole=pickInt(1,3),n=pickInt(1,d-1);return {q:{type:'mix2imp',whole,n,d},key:`M2I:${whole}|${n}/${d}`}}
      if(m==='visual'){const d=[3,4,5,6,8,10,12][pickInt(0,6)],n=pickInt(1,d-1);return {q:{type:'visual',n,d},key:`V:${n}/${d}`}}
    }
    function buildDayQuestions(){const modes=['judge','imp2mix','mix2imp','visual'];while(state.todays.length<state.count){const m=modes[pickInt(0,modes.length-1)];const {q,key}=genQByType(m);if(!state.used.has(key)){state.used.add(key);state.todays.push(q)}}}

    /******** ä»‹é¢ ********/
    function renderHint(q){
      const hints={
        judge:'ğŸ“˜ é¡Œç›®èªªæ˜ï¼šè«‹å¾ä¸‹é¢é¸æ“‡ã€ŒçœŸåˆ†æ•¸ã€æˆ–ã€Œå‡åˆ†æ•¸ã€ã€‚',
        imp2mix:'ğŸ“˜ é¡Œç›®èªªæ˜ï¼šè«‹è¼¸å…¥ã€Œæ•´æ•¸ã€åˆ†å­ã€åˆ†æ¯ã€ï¼Œå†æŒ‰é€å‡ºã€‚',
        mix2imp:'ğŸ“˜ é¡Œç›®èªªæ˜ï¼šè«‹è¼¸å…¥ã€Œæ–°çš„åˆ†å­ã€åˆ†æ¯ã€ï¼Œå†æŒ‰é€å‡ºã€‚',
        visual:(d)=>`ğŸ“˜ é¡Œç›®èªªæ˜ï¼šè«‹çœ‹åœ–è¼¸å…¥<b>è—è‰²æœ‰å¹¾ç‰‡</b>ä½œç‚ºã€Œåˆ†å­ã€ï¼Œåˆ†æ¯å·²å›ºå®šç‚º <b>${d}</b>ï¼›å†é¸æ“‡çœŸåˆ†æ•¸æˆ–å‡åˆ†æ•¸ï¼ŒæŒ‰é€å‡ºã€‚`
      };
      if(q.type==='visual') return `<div class="hint">${hints.visual(q.d)}</div>`
      return `<div class="hint">${hints[q.type]}</div>`
    }
    function renderModebar(){const bar=document.getElementById('modebar');bar.innerHTML='';MODES.forEach(m=>{const b=document.createElement('button');b.className='btn';b.textContent=m.name;b.setAttribute('aria-current',m.key===state.modeSel);b.onclick=()=>{switchMode(m.key)};bar.appendChild(b)})}
    function renderViewbar(){const vb=document.getElementById('viewbar');vb.innerHTML='';[['practice','é–‹å§‹ç·´ç¿’'],['teach','æš–èº«æ•™å­¸']].forEach(([key,label])=>{const b=document.createElement('button');b.className='btn small';b.textContent=label;b.setAttribute('aria-current',state.view===key);b.onclick=()=>{state.view=key;state.practiceHint=false; if(key==='teach') renderTeach(); else renderCurrent();};vb.appendChild(b)})}

    function renderCurrent(){ if(state.view==='teach'){renderTeach(); return;} 
      const q=state.todays[state.idx];
      const box=document.getElementById('qbox');
      if(!q){box.innerHTML='<p class="big">ä»Šå¤©å®Œæˆå•¦ ğŸ‰</p>';return}
      let html=renderHint(q);
      // é¡Œå¾Œå³æ™‚å›é¥‹
      html += '<div id="feedback" class="pill" style="display:none;margin-bottom:8px"></div>';
      if(q.type==='judge'){
        html+=`<div class="big">åˆ¤æ–·ï¼š${makeFracSpan(q.n,q.d)}</div>`;
        html+=`<div class="row"><button class="btn primary" id="btnProper">çœŸåˆ†æ•¸</button><button class="btn" id="btnImproper">å‡åˆ†æ•¸</button></div>`
      }
      if(q.type==='imp2mix'){
        html+=`<div class="big">æŠŠ ${makeFracSpan(q.n,q.d)} è®Šæˆå¸¶åˆ†æ•¸</div>`;
        html+=`<div class="input" style="margin-top:8px"><label>æ•´æ•¸ <input type="number" id="W"/></label><span>${makeFracSpan('<input id="N" type="number" style="width:72px">','<input id="D" type="number" style="width:72px">')}</span></div><p class="muted">æç¤ºï¼šåš ${q.n} Ã· ${q.d}ï¼Œå•†=æ•´æ•¸ï¼Œé¤˜æ•¸=æ–°çš„åˆ†å­ï¼›åˆ†æ¯ä¸è®Šã€‚</p>`
      }
      if(q.type==='mix2imp'){
        html+=`<div class="big">æŠŠ <b>${q.whole}</b> ${makeFracSpan(q.n,q.d)} è®Šæˆå‡åˆ†æ•¸</div>`;
        html+=`<div class="input" style="margin-top:8px">${makeFracSpan('<input id="N" type="number" style="width:88px">','<input id="D" type="number" style="width:88px">')}</div><p class="muted">æç¤ºï¼šå…ˆç®— ${q.whole}Ã—${q.d}+${q.n} ä½œç‚ºæ–°çš„åˆ†å­ï¼Œåˆ†æ¯ä¸è®Šã€‚</p>`
      }
      if(q.type==='visual'){
        // åœ–ï¼‹åƒ…è¼¸å…¥åˆ†å­ï¼›åˆ†æ¯é–å®š
        html+=`<div class="row" style="align-items:center;gap:16px"><div>${drawPieSVG(q.d,q.n)}</div><div class="big">å¯«å‡ºåˆ†æ•¸ & åˆ¤æ–·</div></div>`;
        html+=`<div class="input" style="margin-top:8px;gap:12px">
          <label>åˆ†å­(è—è‰²å¹¾ç‰‡) <input id="N" type="number" min="0" max="${q.d}" aria-label="åˆ†å­"></label>
          <label>åˆ†æ¯ <input id="D" type="number" value="${q.d}" disabled aria-label="åˆ†æ¯(é–å®š)"></label>
          <button class="btn small" id="btnProper">çœŸåˆ†æ•¸</button>
          <button class="btn small" id="btnImproper">å‡åˆ†æ•¸</button>
        </div>
        <div class="row" style="gap:6px;margin-top:6px">
          <button class="btn small" id="minus1">ï¼1</button>
          <button class="btn small" id="plus1">ï¼‹1</button>
        </div>`
      }
      box.innerHTML=html;

      // ç¶å®šäº’å‹•
      if(q.type==='judge'){
        document.getElementById('btnProper').onclick=()=>judgeAnswer('proper');
        document.getElementById('btnImproper').onclick=()=>judgeAnswer('improper');
      }
      if(q.type==='imp2mix'){
        document.getElementById('D').value=q.d;
        const enter=(e)=>{if(e.key==='Enter') checkImp2Mix();}
        ;['W','N','D'].forEach(id=>document.getElementById(id).addEventListener('keydown',enter));
        const submit=document.createElement('button'); submit.className='btn primary'; submit.textContent='é€å‡º'; submit.onclick=checkImp2Mix; box.appendChild(submit);
      }
      if(q.type==='mix2imp'){
        document.getElementById('D').value=q.d;
        const enter=(e)=>{if(e.key==='Enter') checkMix2Imp();}
        ;['N','D'].forEach(id=>document.getElementById(id).addEventListener('keydown',enter));
        const submit=document.createElement('button'); submit.className='btn primary'; submit.textContent='é€å‡º'; submit.onclick=checkMix2Imp; box.appendChild(submit);
      }
      if(q.type==='visual'){
        const enter=(e)=>{if(e.key==='Enter') judgeVisual();}
        ;['N'].forEach(id=>document.getElementById(id).addEventListener('keydown',enter));
        // stepper
        document.getElementById('minus1').onclick=()=>{const n=document.getElementById('N'); n.value=Math.max(0,(+n.value||0)-1)};
        document.getElementById('plus1').onclick=()=>{const n=document.getElementById('N'); n.value=Math.min(q.d,(+n.value||0)+1)};
        document.getElementById('btnProper').onclick=()=>{document.getElementById('btnProper').dataset.flag='proper'};
        document.getElementById('btnImproper').onclick=()=>{document.getElementById('btnProper').dataset.flag='improper'};
        const submit=document.createElement('button'); submit.className='btn primary'; submit.style.marginTop='8px'; submit.textContent='é€å‡º'; submit.onclick=judgeVisual; box.appendChild(submit);
      }

      // è¦–è¦ºåŒ–ï¼šåŒæ­¥åœ¨å·¦å´é¡¯ç¤ºï¼ˆç·´ç¿’é è¨­ä¸é¡¯ç¤ºç­”æ¡ˆï¼‰
      let n=q.n,d=q.d; if(q.type==='mix2imp'){n=q.whole*q.d+q.n;d=q.d}
      renderInlineVizByFrac(n,d, state.view==='teach' || state.practiceHint===true);
      // é¡¯ç¤ºæç¤ºæŒ‰éˆ•ï¼ˆåƒ…ç·´ç¿’æ¨¡å¼ï¼‰
      const vizTitle=document.querySelector('#viz .viz-title');
      if(state.view==='practice'){
        const hintBtn=document.createElement('button');
        hintBtn.className='btn small';
        hintBtn.textContent='é¡¯ç¤ºæç¤º';
        hintBtn.onclick=()=>{state.practiceHint=true; renderInlineVizByFrac(n,d,true)};
        vizTitle.appendChild(hintBtn);
      }
    }

    function renderNext(){renderCurrent();document.getElementById('idx').textContent=state.idx+1;document.getElementById('bar').style.width=((state.idx)/state.count*100)+'%'}

    // é¡Œå¾Œå›é¥‹
    function showFeedback(ok,msg){
      const f=document.getElementById('feedback');
      if(!f) return;
      f.style.display='inline-block';
      f.style.background=ok?'#dcfce7':'#fee2e2';
      f.style.color=ok?'#166534':'#991b1b';
      f.textContent=(ok?'âœ… ':'âŒ ')+msg;
    }

    function right(){state.score++;showFeedback(true,'ç­”å°äº†ï¼');toast(true);nextQ()}
    function wrong(text){showFeedback(false,text);toast(false, text);nextQ()}
    function nextQ(){saveHistoryLine();state.idx++;if(state.idx>=state.count){document.getElementById('bar').style.width='100%';document.getElementById('idx').textContent=state.count;document.getElementById('score').textContent=state.score;document.getElementById('qbox').innerHTML=`<p class="big">å¤ªæ£’äº†ï¼ä»Šå¤©å®Œæˆ ${state.count} é¡Œ âœ”ï¸</p><p>å¾—åˆ†ï¼š<b>${state.score}</b>ï¼${state.count}</p>`;renderHistory(true);return}document.getElementById('score').textContent=state.score;renderNext()}
    function toast(ok,text){const t=document.createElement('div');t.className='pill';t.style.position='fixed';t.style.right='16px';t.style.bottom='16px';t.style.zIndex='9';t.style.background=ok?'#dcfce7':'#fee2e2';t.style.color=ok?'#166534':'#991b1b';t.innerHTML=ok?'âœ… ç­”å°äº†ï¼':`âŒ å†æƒ³æƒ³${text?('ï¼š'+text):''}`;document.body.appendChild(t);setTimeout(()=>t.remove(),1400)}

    // ä½œç­”æª¢æŸ¥
    function judgeAnswer(chosen){const q=state.todays[state.idx];const isProper=q.n<q.d;const pick=(chosen==='proper');if((isProper&&pick)||(!isProper&&!pick))right();else wrong(isProper?'æ‡‰ç‚ºã€ŒçœŸåˆ†æ•¸ã€':'æ‡‰ç‚ºã€Œå‡åˆ†æ•¸ã€')}
    function checkImp2Mix(){const q=state.todays[state.idx];const W=+document.getElementById('W').value;const N=+document.getElementById('N').value;const D=+document.getElementById('D').value;const {whole,n}=toMixed(q.n,q.d);if(W===whole&&N===n&&D===q.d)right();else wrong(`æ­£ç¢ºï¼š${whole} ${q.n%q.d}/${q.d}`)}
    function checkMix2Imp(){const q=state.todays[state.idx];const N=+document.getElementById('N').value;const D=+document.getElementById('D').value;const newN=q.whole*q.d+q.n;if(N===newN&&D===q.d)right();else wrong(`æ­£ç¢ºï¼š${newN}/${q.d}`)}
    function judgeVisual(){const q=state.todays[state.idx];const N=+document.getElementById('N').value;const D=q.d; // åˆ†æ¯é–å®š
      if(N===q.n){const flag=document.getElementById('btnProper').dataset.flag;const isProper=q.n<q.d;const ok=(flag===(isProper?'proper':'improper'));if(ok)right();else wrong(isProper?'å±¬ã€ŒçœŸåˆ†æ•¸ã€':'å±¬ã€Œå‡åˆ†æ•¸ã€')}else wrong(`åœ–æ˜¯ ${q.n}/${q.d}`)}

    // æ­·å²ï¼ˆé¡¯ç¤ºæ–¼ modalï¼‰
    function saveHistoryLine(){const h=JSON.parse(localStorage.getItem(state.historyKey)||'[]');h.push({i:state.idx+1,score:state.score});localStorage.setItem(state.historyKey,JSON.stringify(h))}
    function renderHistory(final=false){const hist=JSON.parse(localStorage.getItem(state.historyKey)||'[]');const box=document.getElementById('hist');if(!box) return; if(!hist.length){box.textContent='ï¼ˆå°šç„¡ç´€éŒ„ï¼‰';return}box.innerHTML=hist.map(r=>`ç¬¬${r.i}é¡Œå¾Œ â†’ å¾—åˆ† ${r.score}`).join('<br>');if(final)box.innerHTML+='<br><b>âœ”ï¸ ä»Šæ—¥å®Œæˆ</b>'}

    // åˆ‡æ›é¡Œå‹ï¼ˆåƒ…æ›¿æ›ç•¶å‰é¡Œç›®ï¼‰
    function uniqueReplaceAtIdx(type){let tries=0;const LIMIT=50;while(tries++<LIMIT){const {q,key}=genQByType(type);if(!state.used.has(key)){state.used.add(key);state.todays[state.idx]=q;return}}state.todays[state.idx]=genQByType(type).q}
    function switchMode(type){state.modeSel=type;uniqueReplaceAtIdx(type);renderModebar();renderCurrent()}

    function renderTeach(){
      const box=document.getElementById('qbox');
      // ç°¡æ˜“æ•™å­¸ï¼šç”¨ 3/5 èˆ‰ä¾‹ï¼Œå±•ç¤ºåˆ‡å¡Šã€æ¨™è¨»åˆ†å­åˆ†æ¯èˆ‡çœŸå‡
      const n=3,d=5; const {whole,n:rem}=toMixed(13,5);
      box.innerHTML=`
        <h2>æš–èº«æ•™å­¸</h2>
        <p>å…ˆçœ‹æ‡‚ä¸€å€‹ä¾‹å­ï¼Œå†é–‹å§‹ç·´ç¿’ï¼</p>
        <div class="row" style="align-items:center;gap:16px">
          <div>${drawPieSVG(d,n)}</div>
          <div>
            <div class="pill">åˆ‡æˆ <b>${d}</b> ç­‰ä»½ï¼ˆåˆ†æ¯ï¼‰ï¼å¡—ä¸Š <b>${n}</b> ä»½ï¼ˆåˆ†å­ï¼‰</div>
            <div style="margin-top:8px">å¯«æˆåˆ†æ•¸ï¼š${makeFracSpan(n,d)}ï¼Œå› ç‚º <b>${n} < ${d}</b>ï¼Œæ‰€ä»¥æ˜¯ <span class="tag good">çœŸåˆ†æ•¸</span></div>
          </div>
        </div>
        <hr>
        <div class="row" style="align-items:center;gap:16px">
          <div>${drawPieSVG(5,13%5)}</div>
          <div>
            <div>å‡åˆ†æ•¸ä¾‹å­ï¼š${makeFracSpan(13,5)}ï¼Œå¯ä»¥æ›æˆå¸¶åˆ†æ•¸ <b>${whole}</b> åˆ ${makeFracSpan(rem,5)}</div>
            <div class="muted">æ–¹æ³•ï¼šåˆ†å­Ã·åˆ†æ¯ï¼å•†ï¼ˆæ•´æ•¸ï¼‰ã€é¤˜æ•¸ï¼ˆæ–°åˆ†å­ï¼‰ï¼Œåˆ†æ¯ä¸è®Šã€‚</div>
          </div>
        </div>
        <div class="row" style="margin-top:16px"><button class="btn primary" id="startPractice">é–‹å§‹ç·´ç¿’</button></div>
      `;
      document.getElementById('startPractice').onclick=()=>{state.view='practice'; state.practiceHint=false; renderCurrent();}
    }

    // åˆå§‹åŒ–èˆ‡æŒ‰éˆ•
    window.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('rerollBtn').onclick=()=>{ uniqueReplaceAtIdx(state.modeSel); renderCurrent(); };
      document.getElementById('skipBtn').onclick=()=>nextQ();
      // modal é–‹é—œ
      const modal=document.getElementById('logModal');
      document.getElementById('openLog').onclick=()=>{ renderHistory(); modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); };
      document.getElementById('closeLog').onclick=()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); };
      modal.addEventListener('click',(e)=>{ if(e.target===modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }});
      // å•Ÿå‹•ä»Šæ—¥
      state.seed=todaySeed(); state.rng=seededRand(state.seed); state.idx=0; state.score=0; state.used.clear(); state.todays=[]; state.modeSel='judge'; state.historyKey='frac-history-'+state.seed;
      document.getElementById('seedInfo').textContent='seed '+state.seed; document.getElementById('total').textContent=state.count; document.getElementById('score').textContent=0; document.getElementById('idx').textContent=0; document.getElementById('bar').style.width='0%';
      renderModebar(); renderViewbar(); buildDayQuestions(); renderNext(); renderHistory();
    });

    // å…§å»ºæ¸¬è©¦ï¼ˆä¸å¯æ”¹å‹•ï¼Œé™¤ééŒ¯èª¤ï¼‰
    (function tests(){
      console.log('%c[Tests] start','color:#4f46e5');
      console.assert(JSON.stringify(toMixed(13,5))==='{"whole":2,"n":3,"d":5}','13/5 -> 2 3/5');
      const tmp=(q)=>{const {whole,n,d}=toMixed(q.n,q.d);return `${whole} ${n}/${d}`};
      console.assert(tmp({n:9,d:4})==='2 1/4','9/4 -> 2 1/4');
      console.assert((6<8)===true,'6/8 proper');
      console.assert((9<8)===false,'9/8 improper');
      // è¿½åŠ 
      console.assert(JSON.stringify(toMixed(8,3))==='{"whole":2,"n":2,"d":3}','8/3 -> 2 2/3');
      console.assert(JSON.stringify(toMixed(7,7))==='{"whole":1,"n":0,"d":7}','7/7 -> 1 0/7');
      // æ–°å¢ï¼šè¦–è¦ºé¡Œé‚è¼¯ï¼ˆåˆ†æ¯é–å®šï¼‰
      (function(){const q={type:'visual',n:2,d:5};const expectD=5;if(q.d!==expectD) throw new Error('visual denominator not locked');})();
      // æ–°å¢ï¼šshowFeedback å­˜åœ¨
      console.assert(typeof showFeedback==='function','showFeedback should exist');
      console.log('%c[Tests] ok','color:#16a34a');
    })();
  </script>
</body>
</html>
