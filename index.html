<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>四年級｜真分數與假分數練習</title>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --gray-100: #f5f5f5;
      --gray-200: #e5e5e5;
      --gray-300: #d4d4d4;
      --gray-700: #374151;
      --gray-900: #111827;
      --success: #10b981;
      --error: #ef4444;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family:sans-serif; background:var(--gray-100); color:var(--gray-900); }
    .container { max-width: 840px; margin:0 auto; padding:1rem; }
    h1 { font-size:1.5rem; margin:0.5rem 0 0.25rem; }
    h2 { font-size:1.25rem; margin:1rem 0 0.5rem; }
    p { margin:0.25rem 0; line-height:1.5; }
    .nav { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1rem; }
    .nav button{ padding:.4rem .8rem; border:1px solid var(--gray-300); border-radius:.375rem; background:#fff; color:var(--gray-900); cursor:pointer; font-size:.9rem; transition:background .2s;}
    .nav button:hover{ background:var(--gray-200);}
    .nav button.active{ background:var(--primary); color:#fff; border-color:var(--primary-dark); }
    .modebar{ margin-bottom:1rem;}
    .question{ margin-bottom:1rem;}
    .question h3{ font-size:1.1rem; margin-bottom:.5rem;}
    .input-row{ display:flex; align-items:center; flex-wrap:wrap; gap:.5rem; margin-bottom:.5rem;}
    .input-row input[type="number"], .input-row input[type="text"]{ width:4rem; padding:.4rem; border:1px solid var(--gray-300); border-radius:.375rem; font-size:1rem;}
    .input-row button.option{ padding:.4rem .7rem; border:1px solid var(--gray-300); border-radius:.375rem; background:#fff; cursor:pointer; font-size:1rem; transition:background .2s;}
    .input-row button.option.selected{ background:var(--primary); color:#fff; border-color:var(--primary-dark); }
    .btn{ display:inline-block; padding:.5rem 1rem; border-radius:.375rem; border:none; background:var(--primary); color:#fff; font-size:1rem; cursor:pointer; transition:background .2s;}
    .btn:hover{ background:var(--primary-dark);}
    .feedback{ margin-top:.5rem; font-weight:bold;}
    .feedback.success{ color:var(--success); }
    .feedback.error{ color:var(--error); }

    /* 視覺化長條 */
    .bar-container{ display:flex; flex-wrap:wrap; gap:.25rem; margin:.5rem 0;}
    .bar{ display:flex; gap:.1rem;}
    .cell{ width:24px; height:24px; border:1px solid var(--gray-300); border-radius:.125rem; background:var(--gray-200); }
    .cell.filled{ background:var(--primary); }

    /* 數線 */
    .numberline{ margin:1rem 0; width:100%; height:60px; }

    /* 記錄面板 */
    .record-panel{ position:fixed; bottom:1rem; right:1rem; z-index:100; }
    .record-button{ position:fixed; bottom:1.5rem; right:1.5rem; background:var(--primary); color:#fff; border:none; border-radius:50%; width:48px; height:48px; font-size:1.5rem; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .record-modal{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; }
    .record-modal.active{ display:flex; }
    .record-modal .panel{ background:#fff; max-width:90%; max-height:90%; overflow-y:auto; padding:1rem; border-radius:.5rem; }
    .record-modal .panel h3{ margin-top:0; }
    .record-modal table{ border-collapse:collapse; width:100%; margin-top:.5rem;}
    .record-modal td, .record-modal th{ border:1px solid var(--gray-300); padding:.4rem; font-size:.85rem;}

    /* 進度條 */
    .progress-wrapper{ width:100%; height:8px; background:var(--gray-300); border-radius:4px; margin-bottom:4px; overflow:hidden;}
    .progress-bar{ height:100%; background:var(--primary); border-radius:4px; width:0;}
    .progress-text{ font-size:.9rem; margin-bottom:.5rem;}

    /* 視覺分數（像你貼的圖） */
    .frac{ display:inline-flex; flex-direction:column; align-items:center; line-height:1; margin:0 .2rem; }
    .frac .top,.frac .bottom{ font-weight:700; font-size:1.35em; }
    .frac.xl .top,.frac.xl .bottom{ font-size:1.75em; }
    .frac .bar{ width:1.5em; height:2px; background:#222; margin:.2rem 0; }
    .mix { display:inline-flex; align-items:center; gap:.3rem; }
    .mix .whole{ font-weight:700; font-size:1.15em; }

    @media (max-width: 600px){
      h1{ font-size:1.25rem;}
      .nav button{ font-size:.8rem; }
      .input-row input[type="number"], .input-row input[type="text"]{ width:3rem; }
      .frac .top,.frac .bottom{ font-size:1.2em; }
      .frac.xl .top,.frac.xl .bottom{ font-size:1.5em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>四年級｜真分數與假分數 練習</h1>
    <p>每天 10 題，題目不重複；先看懂真分數、假分數、帶分數，再開始闖關！</p>
    <div class="nav" id="nav"></div>
    <div id="main"></div>
  </div>

  <!-- 今日紀錄 -->
  <div class="record-panel">
    <button class="record-button" id="recordBtn">📒</button>
  </div>
  <div class="record-modal" id="recordModal">
    <div class="panel">
      <h3>今天的練習紀錄</h3>
      <div id="recordContent"></div>
      <button class="btn" id="closeRecord">關閉</button>
    </div>
  </div>

  <script>
  (function(){
    /* ========= 工具：視覺分數/混合數 ========= */
    function fracHTML(n, d, size='lg'){
      return `<span class="frac ${size==='xl'?'xl':''}">
        <span class="top">${n}</span>
        <span class="bar"></span>
        <span class="bottom">${d}</span>
      </span>`;
    }
    function mixHTML(w, n, d, size='lg'){
      return `<span class="mix"><span class="whole">${w}</span>又 ${fracHTML(n,d,size)}</span>`;
    }

    /* ========= 亂數與日期 ========= */
    function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
    function getTodayStr(){ const d=new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yyyy}${mm}${dd}`; }

    const state={ mode:'warmup', idx:0, score:0, questions:[], rng:null, seed:0, attempt:1, logKey:'', sessionDetails:[] };

    function loadAttempt(){ const key='frac-attempt-'+getTodayStr(); return parseInt(localStorage.getItem(key)||'0',10); }
    function saveAttempt(num){ const key='frac-attempt-'+getTodayStr(); localStorage.setItem(key,String(num)); }
    function saveSessionRecord(record){ const logKey='frac-log-'+getTodayStr(); let list=[]; try{ list=JSON.parse(localStorage.getItem(logKey)||'[]'); }catch(e){} list.push(record); localStorage.setItem(logKey,JSON.stringify(list)); }
    function getSessionRecords(){ const logKey='frac-log-'+getTodayStr(); try{ return JSON.parse(localStorage.getItem(logKey)||'[]'); }catch(e){ return []; } }

    /* ========= 題庫產生 ========= */
    function generateBasicQuestions(count){
      const qs=[]; const categories=['judge','imp2mix','mix2imp'];
      for(let i=0;i<count;i++){
        const type=categories[i%categories.length];
        if(type==='judge'){
          let d=Math.floor(state.rng()*7)+6; // 6-12
          let n=Math.floor(state.rng()*20)+1; // 1-20（可超過分母）
          qs.push({type:'judge', n,d, correct:(n<d)?'proper':(n===d?'equal':'improper')});
        }else if(type==='imp2mix'){
          let d=Math.floor(state.rng()*7)+4; // 4-10
          let whole=Math.floor(state.rng()*4)+2; // 2-5
          let rem=Math.floor(state.rng()*d)+1; // 1..d
          let n=whole*d+rem;
          qs.push({type:'imp2mix', n,d, whole, rem});
        }else if(type==='mix2imp'){
          let d=Math.floor(state.rng()*7)+3; // 3-9
          let whole=Math.floor(state.rng()*4)+2; // 2-5
          let rem=Math.floor(state.rng()*(d-1))+1; // 1..d-1
          let n=whole*d+rem;
          qs.push({type:'mix2imp', whole, nPart:rem, d, n});
        }
      }
      for(let i=qs.length-1;i>0;i--){ const j=Math.floor(state.rng()*(i+1)); [qs[i],qs[j]]=[qs[j],qs[i]]; }
      return qs;
    }

    function generateAdvancedQuestions(count){
      const qs=[]; const categories=['visualMulti','compare','numberLine'];
      for(let i=0;i<count;i++){
        const type=categories[i%categories.length];
        if(type==='visualMulti'){
          let d=Math.floor(state.rng()*8)+5; // 5-12
          let max=d*(Math.floor(state.rng()*2)+2); // 2或3條
          let n=Math.floor(state.rng()*max)+1;
          qs.push({type:'visualMulti', n,d});
        }else if(type==='compare'){
          let d1=Math.floor(state.rng()*9)+3, d2=Math.floor(state.rng()*9)+3;
          let n1=Math.floor(state.rng()*d1*2)+1, n2=Math.floor(state.rng()*d2*2)+1;
          let v1=n1/d1, v2=n2/d2;
          let sign=Math.abs(v1-v2)<1e-9?'=':(v1>v2?'>':'<');
          qs.push({type:'compare', n1,d1,n2,d2, correct:sign});
        }else if(type==='numberLine'){
          let units=Math.floor(state.rng()*2)+1; // 1-2
          let d=Math.floor(state.rng()*5)+2; // 2-6
          let total=d*units+1;
          let idx=Math.floor(state.rng()*(total-2))+1;
          let n=idx;
          qs.push({type:'numberLine', units, d, idx, correct:{n,d}});
        }
      }
      for(let i=qs.length-1;i>0;i--){ const j=Math.floor(state.rng()*(i+1)); [qs[i],qs[j]]=[qs[j],qs[i]]; }
      return qs;
    }

    function generateAppliedQuestions(count){
      const qs=[]; const categories=['appliedPack','appliedShaded','appliedInterval'];
      for(let i=0;i<count;i++){
        const type=categories[i%categories.length];
        if(type==='appliedPack'){
          let d=Math.floor(state.rng()*5)+4; // 4-8
          let maxN=d*(Math.floor(state.rng()*2)+2);
          let n=Math.floor(state.rng()*maxN)+1;
          let whole=Math.floor(n/d), rem=n%d;
          qs.push({type:'appliedPack', d,n, whole, rem});
        }else if(type==='appliedShaded'){
          let d=Math.floor(state.rng()*6)+3; // 3-8
          let n=Math.floor(state.rng()*(d*2))+1; // 1..2d
          let relation=n<d?'<':(n===d?'=':'>');
          qs.push({type:'appliedShaded', d,n, relation});
        }else if(type==='appliedInterval'){
          // ★ 改為 1–5 隨機，再取 [a, a+1] 區間
          let a=Math.floor(state.rng()*5)+1; // 1..5
          let b=a+1;
          const options=[]; let correctCount=0; const totalOptions=6;
          for(let j=0;j<totalOptions;j++){
            let denom=Math.floor(state.rng()*8)+3; // 3-10
            let whole=Math.floor(state.rng()*3); // 0-2
            let numer=Math.floor(state.rng()*denom);
            if(numer===0 && whole===0) numer=1;
            const value=(whole*denom+numer)/denom;
            const text=(whole>0?`${whole} `:'')+`${numer}/${denom}`;
            const isCorrect=(value>a && value<b);
            if(isCorrect) correctCount++;
            options.push({text, correct:isCorrect});
          }
          if(!correctCount){
            let denom=Math.floor(state.rng()*4)+3; let numer=Math.floor(denom*0.5);
            options[0]={text:`${numer}/${denom}`, correct:true};
          }
          qs.push({type:'appliedInterval', a,b, options});
        }
      }
      for(let i=qs.length-1;i>0;i--){ const j=Math.floor(state.rng()*(i+1)); [qs[i],qs[j]]=[qs[j],qs[i]]; }
      return qs;
    }

    /* ========= 導航與暖身 ========= */
    function renderNav(){
      const nav=document.getElementById('nav'); nav.innerHTML='';
      const modes=[ {id:'warmup',label:'暖身教學'}, {id:'basic',label:'基本練習'}, {id:'advanced',label:'進階練習'}, {id:'applied',label:'應用練習'} ];
      modes.forEach(m=>{
        const btn=document.createElement('button');
        btn.textContent=m.label; btn.dataset.mode=m.id; if(state.mode===m.id) btn.classList.add('active');
        btn.addEventListener('click',()=>{
          state.mode=m.id;
          if(m.id==='warmup'){ renderNav(); renderWarmup(); }
          else { initPractice(m.id); }
        });
        nav.appendChild(btn);
      });
    }

    function renderWarmup(){
      const main=document.getElementById('main'); main.innerHTML='';
      const div=document.createElement('div');
      div.innerHTML=`
        <h2>暖身教學</h2>
        <p>先看懂一個例子，再開始練習！</p>
        <div style="border:1px solid var(--gray-300); border-radius:.5rem; padding:1rem; margin-bottom:1rem;">
          <h3>什麼是真分數？</h3>
          <p>把一根長條平均分成 <b>5 等份</b>（分母），塗上 <b>3 份</b>（分子），寫成分數：<span id="p-frac"></span>。因為 <b>3 &lt; 5</b>，所以是 <span style="color:var(--success); font-weight:bold;">真分數</span>。</p>
          <div class="bar-container" id="warmup-proper-bar"></div>
        </div>
        <div style="border:1px solid var(--gray-300); border-radius:.5rem; padding:1rem; margin-bottom:1rem;">
          <h3>什麼是假分數？什麼是帶分數？</h3>
          <p>假分數的分子比分母大。例如分數 <span id="ex-imp"></span> 可以換成帶分數 <span id="ex-mix"></span>，因為 <b>13 ÷ 5 = 2</b> 餘 <b>3</b>。</p>
          <p>再看另一個例子：假分數 <span id="ex-imp2"></span> 可以換成 <span id="ex-mix2"></span>。下圖顯示三個完整的長條，再加上一個長條塗了 3 份，便是 <span id="ex-mix2-again"></span>。</p>
          <div class="bar-container" id="warmup-improper-bar"></div>
        </div>
        <button class="btn" id="startPractice">開始練習！</button>
      `;
      document.getElementById('main').appendChild(div);
      // 填真分數 3/5
      div.querySelector('#p-frac').innerHTML = fracHTML(3,5);
      // 13/5 = 2 又 3/5
      div.querySelector('#ex-imp').innerHTML = fracHTML(13,5);
      div.querySelector('#ex-mix').innerHTML = mixHTML(2,3,5);
      // 15/4 = 3 又 3/4
      div.querySelector('#ex-imp2').innerHTML = fracHTML(15,4);
      div.querySelector('#ex-mix2').innerHTML = mixHTML(3,3,4);
      div.querySelector('#ex-mix2-again').innerHTML = mixHTML(3,3,4);

      // 圖示：3/5
      const properWrap=div.querySelector('#warmup-proper-bar');
      const bar1=document.createElement('div'); bar1.className='bar';
      for(let i=0;i<5;i++){ const c=document.createElement('div'); c.className='cell'; if(i<3) c.classList.add('filled'); bar1.appendChild(c); }
      properWrap.appendChild(bar1);

      // 圖示：15/4
      const improperWrap=div.querySelector('#warmup-improper-bar');
      const denom=4,total=15, full=Math.floor(total/denom), remainder=total%denom;
      for(let i=0;i<full;i++){ const b=document.createElement('div'); b.className='bar'; for(let j=0;j<denom;j++){ const c=document.createElement('div'); c.className='cell filled'; b.appendChild(c); } improperWrap.appendChild(b); }
      if(remainder>0){ const b=document.createElement('div'); b.className='bar'; for(let j=0;j<denom;j++){ const c=document.createElement('div'); c.className='cell'; if(j<remainder) c.classList.add('filled'); b.appendChild(c); } improperWrap.appendChild(b); }

      div.querySelector('#startPractice').onclick=()=>{ state.mode='basic'; initPractice('basic'); };
    }

    /* ========= 初始化練習 ========= */
    function initPractice(mode){
      renderNav();
      let attempt=loadAttempt()+1; saveAttempt(attempt); state.attempt=attempt;
      const seedStr=getTodayStr()+attempt; let seedInt=0; for(let i=0;i<seedStr.length;i++){ seedInt=(seedInt*31+seedStr.charCodeAt(i))>>>0; }
      state.seed=seedInt; state.rng=mulberry32(seedInt);
      state.idx=0; state.score=0; state.sessionDetails=[]; state.mode=mode;

      const count=10;
      if(mode==='basic') state.questions=generateBasicQuestions(count);
      else if(mode==='advanced') state.questions=generateAdvancedQuestions(count);
      else if(mode==='applied') state.questions=generateAppliedQuestions(count);
      else state.questions=generateBasicQuestions(count);

      state.logKey='frac-log-'+getTodayStr();
      renderCurrentQuestion();
    }

    /* ========= 題目渲染 ========= */
    function renderCurrentQuestion(){
      const main=document.getElementById('main'); main.innerHTML='';
      const progressWrapper=document.createElement('div'); progressWrapper.className='progress-wrapper';
      const progressBar=document.createElement('div'); progressBar.className='progress-bar'; progressBar.style.width=((state.idx)/state.questions.length*100)+'%';
      progressWrapper.appendChild(progressBar);
      const progressText=document.createElement('div'); progressText.className='progress-text'; progressText.textContent=`第 ${state.idx+1} / ${state.questions.length} 題`;
      main.appendChild(progressWrapper); main.appendChild(progressText);

      const idx=state.idx; if(idx>=state.questions.length){ finishPractice(); return; }
      const q=state.questions[idx];

      const container=document.createElement('div'); container.className='question';
      const title=document.createElement('h3');

      /* 圖像式分數標題 */
      if(q.type==='judge'){ title.innerHTML = `判斷： ${fracHTML(q.n,q.d,'xl')}`; }
      else if(q.type==='imp2mix'){ title.innerHTML = `將 ${fracHTML(q.n,q.d,'xl')} 轉換為帶分數`; }
      else if(q.type==='mix2imp'){ title.innerHTML = `將 ${q.whole} ${fracHTML(q.nPart,q.d,'xl')} 轉換成假分數`; }
      else if(q.type==='visualMulti'){ title.textContent = `看圖寫出分數 (分母 ${q.d})`; }
      else if(q.type==='compare'){ title.innerHTML = `比較大小： ${fracHTML(q.n1,q.d1,'xl')} ？ ${fracHTML(q.n2,q.d2,'xl')}`; }
      else if(q.type==='numberLine'){ title.textContent = '數線填空：請填入紅點所代表的分數'; }
      /* ★補上應用題型的題幹 */
      else if(q.type==='appliedPack'){ title.textContent = '應用：把圖示寫成帶分數'; }
      else if(q.type==='appliedShaded'){ title.textContent = '應用：依陰影分數與 1 的大小關係作答'; }
      else if(q.type==='appliedInterval'){ title.textContent = `應用：選出介於 ${q.a} 和 ${q.b} 之間的分數（可複選）`; }
      container.appendChild(title);

      let hint='';
      if(q.type==='judge'){ hint='題目說明：請從下面選擇「真分數」或「假分數」。'; }
      else if(q.type==='imp2mix'){ hint='題目說明：請輸入「整數、分子、分母」，再按送出。'; }
      else if(q.type==='mix2imp'){ hint='題目說明：請輸入新的「分子、分母」，再按送出。'; }
      else if(q.type==='visualMulti'){ hint='題目說明：請看圖輸入藍色格子總數作為「分子」，分母已固定為 '+q.d+'，再按送出。'; }
      else if(q.type==='compare'){ hint='題目說明：請選擇「>」「<」或「=」。'; }
      else if(q.type==='numberLine'){ hint='題目說明：請輸入紅點對應的「分子」，分母為 '+q.d+'；如果分子大於等於分母代表超過 1。'; }
      /* ★補上應用題型的提示 */
      else if(q.type==='appliedPack'){ hint='題目說明：請輸入帶分數的「整數、分子」（分母已固定），再按送出。'; }
      else if(q.type==='appliedShaded'){ hint='題目說明：請輸入分子（分母已固定）並選擇與 1 的關係符號。'; }
      else if(q.type==='appliedInterval'){ hint='題目說明：請勾選所有介於左、右端點之間的分數（可複選）。'; }
      const hintP=document.createElement('p'); hintP.style.background='var(--gray-200)'; hintP.style.padding='.5rem'; hintP.style.borderRadius='.375rem'; hintP.style.marginBottom='.5rem'; hintP.textContent=hint;
      container.appendChild(hintP);

      const inputRow=document.createElement('div'); inputRow.className='input-row';
      const feedback=document.createElement('div'); feedback.className='feedback';

      container.appendChild(inputRow);

      /* 各題型互動（原樣保留） */
      if(q.type==='judge'){
        const btnProper=document.createElement('button'); btnProper.textContent='真分數'; btnProper.className='option';
        const btnImproper=document.createElement('button'); btnImproper.textContent='假分數'; btnImproper.className='option';
        inputRow.appendChild(btnProper); inputRow.appendChild(btnImproper);
        const submitBtn=document.createElement('button'); submitBtn.textContent='送出'; submitBtn.className='btn';
        container.appendChild(submitBtn); container.appendChild(feedback);
        submitBtn.onclick=()=>{
          let choice=null;
          if(btnProper.classList.contains('selected')) choice='proper';
          else if(btnImproper.classList.contains('selected')) choice='improper';
          if(!choice){ feedback.textContent='請先選擇答案'; feedback.className='feedback error'; return; }
          const correct=q.correct;
          if(correct==='equal'){
            if(choice==='improper'){ state.score++; feedback.textContent='答對了！'; feedback.className='feedback success'; }
            else{ feedback.textContent='答案是「假分數」（或整數）。'; feedback.className='feedback error'; }
            state.sessionDetails.push({type:'judge', question:`${q.n}/${q.d}`, user:choice, correct:'假分數', ok:choice==='improper'});
          }else{
            const ok=(correct==='proper' && choice==='proper') || (correct==='improper' && choice==='improper');
            if(ok){ state.score++; feedback.textContent='答對了！'; feedback.className='feedback success'; }
            else{ feedback.textContent=`答錯了，正確是「${correct==='proper'?'真分數':'假分數'}」。`; feedback.className='feedback error'; }
            state.sessionDetails.push({type:'judge', question:`${q.n}/${q.d}`, user:choice==='proper'?'真分數':'假分數', correct:correct==='proper'?'真分數':'假分數', ok:ok});
          }
          setTimeout(()=>{ state.idx++; renderCurrentQuestion(); },900);
        };
        btnProper.onclick=()=>{ btnProper.classList.add('selected'); btnImproper.classList.remove('selected'); };
        btnImproper.onclick=()=>{ btnImproper.classList.add('selected'); btnProper.classList.remove('selected'); };
      }
      else if(q.type==='imp2mix'){
        const wInput=document.createElement('input'); wInput.type='number'; wInput.placeholder='整數'; wInput.min=0; wInput.style.width='4rem';
        const nInput=document.createElement('input'); nInput.type='number'; nInput.placeholder='分子'; nInput.min=0;
        const dInput=document.createElement('input'); dInput.type='number'; dInput.placeholder='分母'; dInput.min=1;
        inputRow.appendChild(wInput); inputRow.appendChild(document.createTextNode(' ')); inputRow.appendChild(nInput); inputRow.appendChild(document.createTextNode('/')); inputRow.appendChild(dInput);
        const submitBtn=document.createElement('button'); submitBtn.textContent='送出'; submitBtn.className='btn';
        container.appendChild(submitBtn); container.appendChild(feedback);
        submitBtn.onclick=()=>{
          const W=parseInt(wInput.value,10), N=parseInt(nInput.value,10), D=parseInt(dInput.value,10);
          if(isNaN(W)||isNaN(N)||isNaN(D)||D<=0){ feedback.textContent='請輸入完整數值'; feedback.className='feedback error'; return; }
          const ok=(W===q.whole && N===q.rem && D===q.d);
          if(ok){ state.score++; feedback.innerHTML='答對了！'; feedback.className='feedback success'; }
          else{ feedback.innerHTML=`答錯了，正確為 ${mixHTML(q.whole,q.rem,q.d)}`; feedback.className='feedback error'; }
          state.sessionDetails.push({type:'imp2mix', question:`${q.n}/${q.d}`, user:`${W} ${N}/${D}`, correct:`${q.whole} ${q.rem}/${q.d}`, ok:ok});
          setTimeout(()=>{ state.idx++; renderCurrentQuestion(); },900);
        };
      }
      else if(q.type==='mix2imp'){
        const barsWrap=document.createElement('div'); barsWrap.className='bar-container';
        const denom=q.d, total=q.n, fullBars=Math.floor(total/denom), remainder=total%denom;
        for(let i=0;i<fullBars;i++){ const bar=document.createElement('div'); bar.className='bar'; for(let j=0;j<denom;j++){ const cell=document.createElement('div'); cell.className='cell filled'; bar.appendChild(cell); } barsWrap.appendChild(bar); }
        if(remainder>0){ const bar=document.createElement('div'); bar.className='bar'; for(let j=0;j<denom;j++){ const cell=document.createElement('div'); cell.className='cell'; if(j<remainder) cell.classList.add('filled'); bar.appendChild(cell); } barsWrap.appendChild(bar); }
        container.appendChild(barsWrap);

        const nInput=document.createElement('input'); nInput.type='number'; nInput.placeholder='分子'; nInput.min=0;
        const dInput=document.createElement('input'); dInput.type='number'; dInput.placeholder='分母'; dInput.min=1;
        inputRow.appendChild(nInput); inputRow.appendChild(document.createTextNode('/')); inputRow.appendChild(dInput);
        const submitBtn=document.createElement('button'); submitBtn.textContent='送出'; submitBtn.className='btn';
        container.appendChild(submitBtn); container.appendChild(feedback);
        submitBtn.onclick=()=>{
          const N=parseInt(nInput.value,10), D=parseInt(dInput.value,10);
          if(isNaN(N)||isNaN(D)||D<=0){ feedback.textContent='請輸入完整數值'; feedback.className='feedback error'; return; }
          const ok=(N===q.n && D===q.d);
          if(ok){ state.score++; feedback.innerHTML='答對了！'; feedback.className='feedback success'; }
          else{ feedback.innerHTML=`答錯了，正確為 ${fracHTML(q.n,q.d)}`; feedback.className='feedback error'; }
          state.sessionDetails.push({type:'mix2imp', question:`${q.whole} ${q.nPart}/${q.d}`, user:`${N}/${D}`, correct:`${q.n}/${q.d}`, ok:ok});
          setTimeout(()=>{ state.idx++; renderCurrentQuestion(); },900);
        };
      }
      else if(q.type==='visualMulti'){
        const wrap=document.createElement('div'); wrap.className='bar-container';
        let whole=Math.floor(q.n/q.d), rem=q.n%q.d;
        for(let i=0;i<whole;i++){ const bar=document.createElement('div'); bar.className='bar'; for(let j=0;j<q.d;j++){ const c=document.createElement('div'); c.className='cell filled'; bar.appendChild(c);} wrap.appendChild(bar); }
        if(rem>0){ const bar=document.createElement('div'); bar.className='bar'; for(let j=0;j<q.d;j++){ const c=document.createElement('div'); c.className='cell'; if(j<rem) c.classList.add('filled'); bar.appendChild(c);} wrap.appendChild(bar); }
        container.appendChild(wrap);

        const nInput=document.createElement('input'); nInput.type='number'; nInput.placeholder='分子'; nInput.min=0;
        const dInput=document.createElement('input'); dInput.type='number'; dInput.value=q.d; dInput.readOnly=true; dInput.style.background='#f0f0f0';
        inputRow.appendChild(nInput); inputRow.appendChild(document.createTextNode('/')); inputRow.appendChild(dInput);
        const submitBtn=document.createElement('button'); submitBtn.textContent='送出'; submitBtn.className='btn';
        container.appendChild(submitBtn); container.appendChild(feedback);
        submitBtn.onclick=()=>{
          const N=parseInt(nInput.value,10);
          if(isNaN(N)){ feedback.textContent='請輸入分子'; feedback.className='feedback error'; return; }
          const ok=(N===q.n);
          if(ok){ state.score++; feedback.innerHTML='答對了！'; feedback.className='feedback success'; }
          else{ feedback.innerHTML=`答錯了，正確為 ${fracHTML(q.n,q.d)}`; feedback.className='feedback error'; }
          state.sessionDetails.push({type:'visualMulti', question:`${q.n}/${q.d}`, user:`${N}/${q.d}`, correct:`${q.n}/${q.d}`, ok:ok});
          setTimeout(()=>{ state.idx++; renderCurrentQuestion(); },900);
        };
      }
      else if(q.type==='compare'){
        const btnGT=document.createElement('button'); btnGT.textContent='>'; btnGT.className='option';
        const btnEQ=document.createElement('button'); btnEQ.textContent='='; btnEQ.className='option';
        const btnLT=document.createElement('button'); btnLT.textContent='<'; btnLT.className='option';
        inputRow.appendChild(btnGT); inputRow.appendChild(btnEQ); inputRow.appendChild(btnLT);
        const submitBtn=document.createElement('button'); submitBtn.textContent='送出'; submitBtn.className='btn';
        container.appendChild(submitBtn); container.appendChild(feedback);
        let choice=null;
        function select(b,val){ btnGT.classList.remove('selected'); btnEQ.classList.remove('selected'); btnLT.classList.remove('selected'); b.classList.add('selected'); choice=val; }
        btnGT.onclick=()=>select(btnGT,'>'); btnEQ.onclick=()=>select(btnEQ,'='); btnLT.onclick=()=>select(btnLT,'<');
        submitBtn.onclick=()=>{
          if(!choice){ feedback.textContent='請先選擇關係'; feedback.className='feedback error'; return; }
          const ok=(choice===q.correct);
          if(ok){ state.score++; feedback.textContent='答對了！'; feedback.className='feedback success'; }
          else{ feedback.textContent=`答錯了，正確為 ${q.correct}`; feedback.className='feedback error'; }
          state.sessionDetails.push({type:'compare', question:`${q.n1}/${q.d1} ? ${q.n2}/${q.d2}`, user:choice, correct:q.correct, ok:ok});
          setTimeout(()=>{ state.idx++; renderCurrentQuestion(); },900);
        };
      }
      else if(q.type==='numberLine'){
        const svg=document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.classList.add('numberline'); svg.setAttribute('width','100%'); svg.setAttribute('height','60');
        const width=600, height=60, d=q.d, units=q.units, totalTicks=d*units+1, startX=20, endX=width-20, lineY=40, step=(endX-startX)/(totalTicks-1);
        const line=document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1',startX); line.setAttribute('y1',lineY); line.setAttribute('x2',endX); line.setAttribute('y2',lineY); line.setAttribute('stroke','#555'); line.setAttribute('stroke-width','2'); svg.appendChild(line);
        for(let i=0;i<totalTicks;i++){ const x=startX+i*step; const tick=document.createElementNS('http://www.w3.org/2000/svg','line'); tick.setAttribute('x1',x); tick.setAttribute('y1',lineY); tick.setAttribute('x2',x); tick.setAttribute('y2',lineY-8); tick.setAttribute('stroke','#555'); tick.setAttribute('stroke-width','2'); svg.appendChild(tick);
          if(i%d===0){ const text=document.createElementNS('http://www.w3.org/2000/svg','text'); text.setAttribute('x',x); text.setAttribute('y',lineY+15); text.setAttribute('font-size','12'); text.setAttribute('text-anchor','middle'); text.textContent=i/d; svg.appendChild(text); } }
        const px=startX+q.idx*step; const circle=document.createElementNS('http://www.w3.org/2000/svg','circle'); circle.setAttribute('cx',px); circle.setAttribute('cy',lineY-12); circle.setAttribute('r','6'); circle.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#6366f1'); svg.appendChild(circle);
        container.appendChild(svg);

        const nInput=document.createElement('input'); nInput.type='number'; nInput.placeholder='分子'; nInput.min=0;
        const dInput=document.createElement('input'); dInput.type='number'; dInput.value=q.d; dInput.readOnly=true; dInput.style.background='#f0f0f0';
        inputRow.appendChild(nInput); inputRow.appendChild(document.createTextNode('/')); inputRow.appendChild(dInput);
        const submitBtn=document.createElement('button'); submitBtn.textContent='送出'; submitBtn.className='btn';
        container.appendChild(submitBtn); container.appendChild(feedback);
        submitBtn.onclick=()=>{
          const N=parseInt(nInput.value,10); if(isNaN(N)){ feedback.textContent='請輸入分子'; feedback.className='feedback error'; return; }
          const ok=(N===q.correct.n);
          if(ok){ state.score++; feedback.innerHTML='答對了！'; feedback.className='feedback success'; }
          else{ feedback.innerHTML=`答錯了，正確為 ${fracHTML(q.correct.n,q.correct.d)}`; feedback.className='feedback error'; }
          state.sessionDetails.push({type:'numberLine', question:`${q.correct.n}/${q.correct.d}`, user:`${N}/${q.correct.d}`, correct:`${q.correct.n}/${q.correct.d}`, ok:ok});
          setTimeout(()=>{ state.idx++; renderCurrentQuestion(); },900);
        };
      }
      else if(q.type==='appliedPack'){
        const barsWrap=document.createElement('div'); barsWrap.className='bar-container';
        let whole=Math.floor(q.n/q.d), rem=q.n%q.d;
        for(let i=0;i<whole;i++){ const bar=document.createElement('div'); bar.className='bar'; for(let j=0;j<q.d;j++){ const c=document.createElement('div'); c.className='cell filled'; bar.appendChild(c);} barsWrap.appendChild(bar); }
        if(rem>0){ const bar=document.createElement('div'); bar.className='bar'; for(let j=0;j<q.d;j++){ const c=document.createElement('div'); c.className='cell'; if(j<rem) c.classList.add('filled'); bar.appendChild(c);} barsWrap.appendChild(bar); }
        container.appendChild(barsWrap);

        const wInput=document.createElement('input'); wInput.type='number'; wInput.placeholder='整數'; wInput.min=0;
        const rInput=document.createElement('input'); rInput.type='number'; rInput.placeholder='分子'; rInput.min=0;
        const dInput=document.createElement('input'); dInput.type='number'; dInput.value=q.d; dInput.readOnly=true; dInput.style.background='#f0f0f0';
        inputRow.appendChild(wInput); inputRow.appendChild(document.createTextNode(' ')); inputRow.appendChild(rInput); inputRow.appendChild(document.createTextNode('/')); inputRow.appendChild(dInput);
        const submitBtn=document.createElement('button'); submitBtn.textContent='送出'; submitBtn.className='btn';
        container.appendChild(submitBtn); container.appendChild(feedback);
        submitBtn.onclick=()=>{
          const W=parseInt(wInput.value,10), R=parseInt(rInput.value,10);
          if(isNaN(W)||isNaN(R)){ feedback.textContent='請輸入完整數值'; feedback.className='feedback error'; return; }
          const ok=(W===q.whole && R===q.rem);
          if(ok){ state.score++; feedback.innerHTML='答對了！'; feedback.className='feedback success'; }
          else{ feedback.innerHTML=`答錯了，正確為 ${mixHTML(q.whole,q.rem,q.d)}`; feedback.className='feedback error'; }
          state.sessionDetails.push({type:'appliedPack', question:`箱大小${q.d}，共有${q.n}`, user:`${W} ${R}/${q.d}`, correct:`${q.whole} ${q.rem}/${q.d}`, ok:ok});
          setTimeout(()=>{ state.idx++; renderCurrentQuestion(); },900);
        };
      }
      else if(q.type==='appliedShaded'){
        const barsWrap=document.createElement('div'); barsWrap.className='bar-container';
        let whole=Math.floor(q.n/q.d), rem=q.n%q.d;
        for(let i=0;i<whole;i++){ const bar=document.createElement('div'); bar.className='bar'; for(let j=0;j<q.d;j++){ const c=document.createElement('div'); c.className='cell filled'; bar.appendChild(c);} barsWrap.appendChild(bar); }
        if(rem>0){ const bar=document.createElement('div'); bar.className='bar'; for(let j=0;j<q.d;j++){ const c=document.createElement('div'); c.className='cell'; if(j<rem) c.classList.add('filled'); bar.appendChild(c);} barsWrap.appendChild(bar); }
        container.appendChild(barsWrap);

        const nInput=document.createElement('input'); nInput.type='number'; nInput.placeholder='分子'; nInput.min=0;
        const dInput=document.createElement('input'); dInput.type='number'; dInput.value=q.d; dInput.readOnly=true; dInput.style.background='#f0f0f0';
        inputRow.appendChild(nInput); inputRow.appendChild(document.createTextNode('/')); inputRow.appendChild(dInput);
        const btnGT=document.createElement('button'); btnGT.textContent='>'; btnGT.className='option';
        const btnEQ=document.createElement('button'); btnEQ.textContent='='; btnEQ.className='option';
        const btnLT=document.createElement('button'); btnLT.textContent='<'; btnLT.className='option';
        inputRow.appendChild(btnGT); inputRow.appendChild(btnEQ); inputRow.appendChild(btnLT);
        const submitBtn=document.createElement('button'); submitBtn.textContent='送出'; submitBtn.className='btn';
        container.appendChild(submitBtn); container.appendChild(feedback);
        let choice=null; function selectSign(b,v){ btnGT.classList.remove('selected'); btnEQ.classList.remove('selected'); btnLT.classList.remove('selected'); b.classList.add('selected'); choice=v; }
        btnGT.onclick=()=>selectSign(btnGT,'>'); btnEQ.onclick=()=>selectSign(btnEQ,'='); btnLT.onclick=()=>selectSign(btnLT,'<');
        submitBtn.onclick=()=>{
          const N=parseInt(nInput.value,10); if(isNaN(N)||choice===null){ feedback.textContent='請輸入分子並選擇關係'; feedback.className='feedback error'; return; }
          const ok=(N===q.n && choice===q.relation);
          if(ok){ state.score++; feedback.innerHTML='答對了！'; feedback.className='feedback success'; }
          else{ feedback.innerHTML=`答錯了，正確為 ${fracHTML(q.n,q.d)} 且關係 ${q.relation}`; feedback.className='feedback error'; }
          state.sessionDetails.push({type:'appliedShaded', question:`${q.n}/${q.d}`, user:`${N}/${q.d} ${choice}`, correct:`${q.n}/${q.d} ${q.relation}`, ok:ok});
          setTimeout(()=>{ state.idx++; renderCurrentQuestion(); },900);
        };
      }
      else if(q.type==='appliedInterval'){
        const listDiv=document.createElement('div'); listDiv.style.display='flex'; listDiv.style.flexWrap='wrap'; listDiv.style.gap='.5rem';
        q.options.forEach((opt,i)=>{ const label=document.createElement('label'); label.style.display='flex'; label.style.alignItems='center'; label.style.cursor='pointer';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.index=i; cb.style.marginRight='.25rem'; label.appendChild(cb); label.appendChild(document.createTextNode(opt.text)); listDiv.appendChild(label); });
        container.appendChild(listDiv);
        const submitBtn=document.createElement('button'); submitBtn.textContent='送出'; submitBtn.className='btn';
        container.appendChild(submitBtn); container.appendChild(feedback);
        submitBtn.onclick=()=>{
          let ok=true; const userSelected=[]; const inputs=listDiv.querySelectorAll('input[type="checkbox"]');
          inputs.forEach((cb,idx)=>{ const isChecked=cb.checked; const correct=q.options[idx].correct; if(isChecked) userSelected.push(q.options[idx].text); if(isChecked!==correct) ok=false; });
          if(ok){ state.score++; feedback.textContent='答對了！'; feedback.className='feedback success'; }
          else{ const correctList=q.options.filter(o=>o.correct).map(o=>o.text).join(', '); feedback.textContent=`答錯了，正確答案為：${correctList}`; feedback.className='feedback error'; }
          state.sessionDetails.push({type:'appliedInterval', question:`範圍${q.a}到${q.b}`, user:userSelected, correct:q.options.filter(o=>o.correct).map(o=>o.text), ok:ok});
          setTimeout(()=>{ state.idx++; renderCurrentQuestion(); },1200);
        };
      }

      main.appendChild(container);
    }

    /* ========= 完成總結 ========= */
    function finishPractice(){
      const main=document.getElementById('main'); main.innerHTML='';
      const summary=document.createElement('div');
      summary.innerHTML=`<h2>今天完成！</h2><p>你答對了 ${state.score} 題，共 ${state.questions.length} 題。</p>`;
      const now=new Date(); const timeStr=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
      saveSessionRecord({ time:timeStr, score:state.score, total:state.questions.length, details:state.sessionDetails });

      const btnAgain=document.createElement('button'); btnAgain.className='btn'; btnAgain.textContent='再練一次';
      btnAgain.onclick=()=>{ initPractice(state.mode); };
      const btnBack=document.createElement('button'); btnBack.className='btn'; btnBack.style.marginLeft='.5rem'; btnBack.textContent='回暖身教學';
      btnBack.onclick=()=>{ state.mode='warmup'; renderNav(); renderWarmup(); };
      summary.appendChild(btnAgain); summary.appendChild(btnBack);
      main.appendChild(summary);
    }

    /* ========= 記錄面板 ========= */
    function showRecordPanel(){
      const records=getSessionRecords(); const content=document.getElementById('recordContent');
      if(!records.length){ content.innerHTML='<p>尚無紀錄。</p>'; }
      else{
        let html='<table><tr><th>時間</th><th>得分</th><th>總題數</th></tr>';
        records.slice().reverse().forEach(r=>{ html+=`<tr><td>${r.time}</td><td>${r.score}</td><td>${r.total}</td></tr>`; });
        html+='</table>'; content.innerHTML=html;
      }
      document.getElementById('recordModal').classList.add('active');
    }

    /* ========= 初始 ========= */
    renderNav(); renderWarmup();
    document.getElementById('recordBtn').onclick=showRecordPanel;
    document.getElementById('closeRecord').onclick=()=>{ document.getElementById('recordModal').classList.remove('active'); };
  })();
  </script>
</body>
</html>
