<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸‰å¹´ç´šï½œçœŸåˆ†æ•¸èˆ‡å‡åˆ†æ•¸ç·´ç¿’</title>
  <style>
    /* åŸºæœ¬æ’ç‰ˆèˆ‡é…è‰² */
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --gray-100: #f5f5f5;
      --gray-200: #e5e5e5;
      --gray-300: #d4d4d4;
      --gray-700: #374151;
      --gray-900: #111827;
      --success: #10b981;
      --error: #ef4444;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--gray-100);
      color: var(--gray-900);
    }
    .container {
      max-width: 840px;
      margin: 0 auto;
      padding: 1rem;
    }
    h1 {
      font-size: 1.5rem;
      margin: 0.5rem 0 0.25rem;
    }
    h2 {
      font-size: 1.25rem;
      margin: 1rem 0 0.5rem;
    }
    p {
      margin: 0.25rem 0;
      line-height: 1.5;
    }
    .nav {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .nav button {
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      background: white;
      color: var(--gray-900);
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    .nav button:hover {
      background: var(--gray-200);
    }
    .nav button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }
    .modebar {
      margin-bottom: 1rem;
    }
    .question {
      margin-bottom: 1rem;
    }
    .question h3 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    .input-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .input-row input[type="number"], .input-row input[type="text"] {
      width: 4rem;
      padding: 0.4rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      font-size: 1rem;
    }
    .input-row button.option {
      padding: 0.4rem 0.7rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      background: white;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .input-row button.option.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }
    .btn {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover {
      background: var(--primary-dark);
    }
    .feedback {
      margin-top: 0.5rem;
      font-weight: bold;
    }
    .feedback.success {
      color: var(--success);
    }
    .feedback.error {
      color: var(--error);
    }
    /* è¦–è¦ºåŒ–æ¢ä»¶æ ¼å­ */
    .bar-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin: 0.5rem 0;
    }
    .bar {
      display: flex;
      gap: 0.1rem;
    }
    .cell {
      width: 24px;
      height: 24px;
      border: 1px solid var(--gray-300);
      border-radius: 0.125rem;
      background: var(--gray-200);
    }
    .cell.filled {
      background: var(--primary);
    }
    /* number line */
    .numberline {
      margin: 1rem 0;
      width: 100%;
      height: 60px;
    }
    /* ç´€éŒ„é¢æ¿æ¨£å¼ */
    .record-panel {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 100;
    }
    .record-button {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .record-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .record-modal.active {
      display: flex;
    }
    .record-modal .panel {
      background: white;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    .record-modal .panel h3 {
      margin-top: 0;
    }
    .record-modal table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 0.5rem;
    }
    .record-modal td, .record-modal th {
      border: 1px solid var(--gray-300);
      padding: 0.4rem;
      font-size: 0.85rem;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.25rem; }
      .nav button { font-size: 0.8rem; }
      .input-row input[type="number"], .input-row input[type="text"] { width: 3rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ä¸‰å¹´ç´šï½œçœŸåˆ†æ•¸èˆ‡å‡åˆ†æ•¸ ç·´ç¿’</h1>
    <p>æ¯å¤© 10 é¡Œï¼Œé¡Œç›®ä¸é‡è¤‡ï¼›å…ˆçœ‹æ‡‚çœŸåˆ†æ•¸ã€å‡åˆ†æ•¸ã€å¸¶åˆ†æ•¸ï¼Œå†é–‹å§‹é—–é—œï¼</p>
    <div class="nav" id="nav"></div>
    <div id="main"></div>
  </div>
  <!-- å­¸ç¿’ç´€éŒ„æŒ‰éˆ•èˆ‡å½ˆçª— -->
  <div class="record-panel">
    <button class="record-button" id="recordBtn">ğŸ“’</button>
  </div>
  <div class="record-modal" id="recordModal">
    <div class="panel">
      <h3>ä»Šå¤©çš„ç·´ç¿’ç´€éŒ„</h3>
      <div id="recordContent"></div>
      <button class="btn" id="closeRecord">é—œé–‰</button>
    </div>
  </div>
  <script>
  (function() {
    // ç°¡æ˜“ç¨®å­äº‚æ•¸ç”Ÿæˆå™¨ (mulberry32)
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }
    function getTodayStr() {
      const d = new Date();
      const yyyy = d.getFullYear().toString();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return yyyy + mm + dd;
    }
    // ç‹€æ…‹
    const state = {
      mode: 'warmup',
      idx: 0,
      score: 0,
      questions: [],
      rng: null,
      seed: 0,
      attempt: 1,
      logKey: '',
      sessionDetails: []
    };
    // è®€å–ç•¶å¤©ç·´ç¿’æ¬¡æ•¸
    function loadAttempt() {
      const key = 'frac-attempt-' + getTodayStr();
      let num = parseInt(localStorage.getItem(key) || '0', 10);
      return num;
    }
    function saveAttempt(num) {
      const key = 'frac-attempt-' + getTodayStr();
      localStorage.setItem(key, String(num));
    }
    // å„²å­˜å®Œæˆçš„ç·´ç¿’ç´€éŒ„
    function saveSessionRecord(record) {
      const logKey = 'frac-log-' + getTodayStr();
      let list = [];
      try { list = JSON.parse(localStorage.getItem(logKey) || '[]'); } catch(err) {}
      list.push(record);
      localStorage.setItem(logKey, JSON.stringify(list));
    }
    // å–å¾—ç´€éŒ„
    function getSessionRecords() {
      const logKey = 'frac-log-' + getTodayStr();
      try { return JSON.parse(localStorage.getItem(logKey) || '[]'); } catch(err) { return []; }
    }
    // ç”¢ç”ŸåŸºç¤é¡Œåº«
    function generateBasicQuestions(count) {
      const qs = [];
      const categories = ['judge','imp2mix','mix2imp'];
      for (let i=0; i<count; i++) {
        const type = categories[i % categories.length];
        if (type === 'judge') {
          // åˆ†å­1-15ï¼Œåˆ†æ¯6-12
          let d = Math.floor(state.rng()*7) + 6; // 6-12
          let n = Math.floor(state.rng()*20) + 1; // 1-20
          // avoid n and d multiples for too trivial; but allow mixture
          qs.push({type:'judge', n: n, d: d, correct: (n < d) ? 'proper' : (n === d ? 'equal' : 'improper')});
        } else if (type === 'imp2mix') {
          let d = Math.floor(state.rng()*7) + 4; // 4-10
          let whole = Math.floor(state.rng()*4) + 2; // 2-5
          let rem = Math.floor(state.rng()*d) + 1; // 1-d
          let n = whole * d + rem;
          qs.push({type:'imp2mix', n: n, d: d, whole: whole, rem: rem});
        } else if (type === 'mix2imp') {
          let d = Math.floor(state.rng()*7) + 3; // 3-9
          let whole = Math.floor(state.rng()*4) + 2; // 2-5
          let rem = Math.floor(state.rng()*(d-1)) + 1; // 1 to d-1
          let n = whole * d + rem;
          qs.push({type:'mix2imp', whole: whole, nPart: rem, d: d, n: n});
        }
      }
      // æ´—ç‰Œ
      for (let i=qs.length-1; i>0; i--) {
        const j = Math.floor(state.rng() * (i+1));
        [qs[i], qs[j]] = [qs[j], qs[i]];
      }
      return qs;
    }
    // ç”¢ç”Ÿé€²éšé¡Œåº«
    function generateAdvancedQuestions(count) {
      const qs = [];
      const categories = ['visualMulti','compare','numberLine'];
      for (let i=0; i<count; i++) {
        const type = categories[i % categories.length];
        if (type === 'visualMulti') {
          // å¤šæ¢åˆ†æ•¸é•·æ¢é¡¯ç¤ºï¼Œåˆ†æ¯5-12ï¼›åˆ†å­ 1 - denom*3
          let d = Math.floor(state.rng()*8) + 5; // 5-12
          let max = d * (Math.floor(state.rng()*2)+2); // 2æˆ–3å€‹é•·æ¢
          let n = Math.floor(state.rng()*max) + 1;
          // ç¢ºä¿ä¸ç‚º0
          qs.push({type:'visualMulti', n: n, d: d});
        } else if (type === 'compare') {
          let d1 = Math.floor(state.rng()*9) + 3; // 3-11
          let d2 = Math.floor(state.rng()*9) + 3;
          let n1 = Math.floor(state.rng()*d1*2) + 1;
          let n2 = Math.floor(state.rng()*d2*2) + 1;
          // avoid trivial equal but may appear seldom; we allow equals for challenge
          // Determine correct
          let v1 = n1 / d1;
          let v2 = n2 / d2;
          let sign;
          if (Math.abs(v1 - v2) < 1e-9) sign = '=';
          else sign = v1 > v2 ? '>' : '<';
          qs.push({type:'compare', n1: n1, d1: d1, n2: n2, d2: d2, correct: sign});
        } else if (type === 'numberLine') {
          // number line from 0 to units (1 or 2 or 3). Denominator2-6
          let units = Math.floor(state.rng()*2) + 1; // 1-2
          let d = Math.floor(state.rng()*5) + 2; // 2-6
          let totalTicks = d * units + 1;
          let idx = Math.floor(state.rng()*(totalTicks-2)) + 1; // not first or last
          // compute improper fraction representation numerator
          let n = idx;
          let correct = {n:n, d:d};
          qs.push({type:'numberLine', units: units, d: d, idx: idx, correct: correct});
        }
      }
      // shuffle
      for (let i=qs.length-1; i>0; i--) {
        const j = Math.floor(state.rng() * (i+1));
        [qs[i], qs[j]] = [qs[j], qs[i]];
      }
      return qs;
    }
    // æ¸²æŸ“å°èˆªæŒ‰éˆ•
    function renderNav() {
      const nav = document.getElementById('nav');
      nav.innerHTML = '';
      const modes = [
        {id:'warmup', label:'æš–èº«æ•™å­¸'},
        {id:'basic', label:'åŸºæœ¬ç·´ç¿’'},
        {id:'advanced', label:'é€²éšç·´ç¿’'},
      ];
      modes.forEach(m => {
        const btn = document.createElement('button');
        btn.textContent = m.label;
        btn.dataset.mode = m.id;
        if (state.mode === m.id) btn.classList.add('active');
        btn.addEventListener('click', () => {
          if (m.id === 'warmup') {
            state.mode = 'warmup';
            renderNav();
            renderWarmup();
          } else if (m.id === 'basic') {
            state.mode = 'basic';
            initPractice('basic');
          } else if (m.id === 'advanced') {
            state.mode = 'advanced';
            initPractice('advanced');
          }
        });
        nav.appendChild(btn);
      });
    }
    // æ¸²æŸ“æš–èº«æ•™å­¸é 
    function renderWarmup() {
      const main = document.getElementById('main');
      main.innerHTML = '';
      const div = document.createElement('div');
      div.innerHTML = `
        <h2>æš–èº«æ•™å­¸</h2>
        <p>å…ˆçœ‹æ‡‚ä¸€å€‹ä¾‹å­ï¼Œå†é–‹å§‹ç·´ç¿’ï¼</p>
        <div style="border:1px solid var(--gray-300); border-radius:0.5rem; padding:1rem; margin-bottom:1rem;">
          <h3>ä»€éº¼æ˜¯çœŸåˆ†æ•¸ï¼Ÿ</h3>
          <p>æŠŠä¸€å€‹åœ“å¹³å‡åˆ†æˆ <b>5 ç­‰ä»½</b>ï¼ˆåˆ†æ¯ï¼‰ï¼Œå¡—ä¸Š <b>3 ä»½</b>ï¼ˆåˆ†å­ï¼‰ï¼Œå¯«æˆåˆ†æ•¸ï¼š<b>3/5</b>ã€‚å› ç‚º <b>3 &lt; 5</b>ï¼Œæ‰€ä»¥æ˜¯ <span style="color:var(--success); font-weight:bold;">çœŸåˆ†æ•¸</span>ã€‚</p>
          <div class="bar-container"></div>
        </div>
        <div style="border:1px solid var(--gray-300); border-radius:0.5rem; padding:1rem;">
          <h3>ä»€éº¼æ˜¯å‡åˆ†æ•¸ï¼Ÿä»€éº¼æ˜¯å¸¶åˆ†æ•¸ï¼Ÿ</h3>
          <p>å‡åˆ†æ•¸çš„åˆ†å­æ¯”åˆ†æ¯å¤§ã€‚ä¾‹å¦‚åˆ†æ•¸ <b>13/5</b> å¯ä»¥æ›æˆå¸¶åˆ†æ•¸ <b>2 åˆ 3/5</b>ï¼Œå› ç‚º <b>13 Ã· 5 = 2</b> é¤˜ <b>3</b>ã€‚</p>
        </div>
        <button class="btn" id="startPractice">é–‹å§‹ç·´ç¿’ï¼</button>
      `;
      main.appendChild(div);
      // å¡«å……ç¤ºæ„åœ–
      const barCtn = div.querySelector('.bar-container');
      // ç¹ªè£½ 5 ç­‰åˆ†é•·æ¢ï¼Œå¡— 3 æ ¼
      const bar = document.createElement('div');
      bar.className = 'bar';
      for (let i=0; i<5; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        if (i<3) cell.classList.add('filled');
        bar.appendChild(cell);
      }
      barCtn.appendChild(bar);
      // Start button
      div.querySelector('#startPractice').onclick = () => {
        state.mode = 'basic';
        initPractice('basic');
      };
    }
    // åˆå§‹åŒ–ç·´ç¿’
    function initPractice(mode) {
      // æ›´æ–°å°èˆª
      renderNav();
      // ç”¢ç”Ÿç¨®å­èˆ‡å˜—è©¦æ¬¡æ•¸
      let attempt = loadAttempt() + 1;
      saveAttempt(attempt);
      state.attempt = attempt;
      const seedStr = getTodayStr() + attempt;
      let seedInt = 0;
      for (let i=0; i<seedStr.length; i++) {
        seedInt = (seedInt * 31 + seedStr.charCodeAt(i)) >>> 0;
      }
      state.seed = seedInt;
      state.rng = mulberry32(seedInt);
      state.idx = 0;
      state.score = 0;
      state.sessionDetails = [];
      state.mode = mode;
      // ç”¢ç”Ÿé¡Œåº«
      const count = 10;
      if (mode === 'basic') {
        state.questions = generateBasicQuestions(count);
      } else {
        state.questions = generateAdvancedQuestions(count);
      }
      // è¨­å®šç•¶å‰è¨˜éŒ„éµ
      state.logKey = 'frac-log-' + getTodayStr();
      renderCurrentQuestion();
    }
    // æ¸²æŸ“ç•¶å‰é¡Œç›®
    function renderCurrentQuestion() {
      const main = document.getElementById('main');
      main.innerHTML = '';
      const idx = state.idx;
      if (idx >= state.questions.length) {
        // çµæŸ
        finishPractice();
        return;
      }
      const q = state.questions[idx];
      const container = document.createElement('div');
      container.className = 'question';
      // æ¨™é¡Œ
      const title = document.createElement('h3');
      let titleTxt = '';
      if (q.type === 'judge') {
        titleTxt = `åˆ¤æ–·ï¼š ${q.n}/${q.d}`;
      } else if (q.type === 'imp2mix') {
        titleTxt = `å°‡ ${q.n}/${q.d} è½‰æ›ç‚ºå¸¶åˆ†æ•¸`;
      } else if (q.type === 'mix2imp') {
        titleTxt = `å°‡ ${q.whole} ${q.nPart}/${q.d} è½‰æ›æˆå‡åˆ†æ•¸`;
      } else if (q.type === 'visualMulti') {
        titleTxt = `çœ‹åœ–å¯«å‡ºåˆ†æ•¸ (åˆ†æ¯ ${q.d})`;
      } else if (q.type === 'compare') {
        titleTxt = `æ¯”è¼ƒå¤§å°ï¼š ${q.n1}/${q.d1}  ?  ${q.n2}/${q.d2}`;
      } else if (q.type === 'numberLine') {
        titleTxt = `æ•¸ç·šå¡«ç©ºï¼šè«‹å¡«å…¥ç´…é»æ‰€ä»£è¡¨çš„åˆ†æ•¸`;
      }
      title.textContent = titleTxt;
      container.appendChild(title);
      // è¼”åŠ©èªªæ˜
      let hint = '';
      if (q.type === 'judge') {
        hint = 'é¡Œç›®èªªæ˜ï¼šè«‹å¾ä¸‹é¢é¸æ“‡ã€ŒçœŸåˆ†æ•¸ã€æˆ–ã€Œå‡åˆ†æ•¸ã€ã€‚';
      } else if (q.type === 'imp2mix') {
        hint = 'é¡Œç›®èªªæ˜ï¼šè«‹è¼¸å…¥ã€Œæ•´æ•¸ã€åˆ†å­ã€åˆ†æ¯ã€ï¼Œå†æŒ‰é€å‡ºã€‚';
      } else if (q.type === 'mix2imp') {
        hint = 'é¡Œç›®èªªæ˜ï¼šè«‹è¼¸å…¥æ–°çš„ã€Œåˆ†å­ã€åˆ†æ¯ã€ï¼Œå†æŒ‰é€å‡ºã€‚';
      } else if (q.type === 'visualMulti') {
        hint = 'é¡Œç›®èªªæ˜ï¼šè«‹çœ‹åœ–è¼¸å…¥è—è‰²æ ¼å­ç¸½æ•¸ä½œç‚ºã€Œåˆ†å­ã€ï¼Œåˆ†æ¯å·²å›ºå®šç‚º ' + q.d + 'ï¼Œå†æŒ‰é€å‡ºã€‚';
      } else if (q.type === 'compare') {
        hint = 'é¡Œç›®èªªæ˜ï¼šè«‹é¸æ“‡ã€Œ>ã€ã€Œ<ã€æˆ–ã€Œ=ã€ã€‚';
      } else if (q.type === 'numberLine') {
        hint = 'é¡Œç›®èªªæ˜ï¼šè«‹è¼¸å…¥ç´…é»å°æ‡‰çš„ã€Œåˆ†å­ã€ï¼Œåˆ†æ¯ç‚º ' + q.d + 'ï¼›å¦‚æœåˆ†å­å¤§æ–¼ç­‰æ–¼åˆ†æ¯ä»£è¡¨è¶…é 1ã€‚';
      }
      const hintP = document.createElement('p');
      hintP.style.background = 'var(--gray-200)';
      hintP.style.padding = '0.5rem';
      hintP.style.borderRadius = '0.375rem';
      hintP.style.marginBottom = '0.5rem';
      hintP.textContent = hint;
      container.appendChild(hintP);
      // é¡Œç›®å…§å®¹ï¼ˆè¼¸å…¥å€ï¼‰
      const inputRow = document.createElement('div');
      inputRow.className = 'input-row';
      // feedback
      const feedback = document.createElement('div');
      feedback.className = 'feedback';
      container.appendChild(inputRow);
      if (q.type === 'judge') {
        // two buttons
        const btnProper = document.createElement('button');
        btnProper.textContent = 'çœŸåˆ†æ•¸';
        btnProper.className = 'option';
        const btnImproper = document.createElement('button');
        btnImproper.textContent = 'å‡åˆ†æ•¸';
        btnImproper.className = 'option';
        inputRow.appendChild(btnProper);
        inputRow.appendChild(btnImproper);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = 'é€å‡º';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        submitBtn.onclick = () => {
          // determine selection
          let choice = null;
          if (btnProper.classList.contains('selected')) choice = 'proper';
          else if (btnImproper.classList.contains('selected')) choice = 'improper';
          if (!choice) {
            feedback.textContent = 'è«‹å…ˆé¸æ“‡ç­”æ¡ˆ';
            feedback.className = 'feedback error';
            return;
          }
          const correct = q.correct;
          const isCorrect = (correct === 'proper' && choice === 'proper') || (correct === 'improper' && choice === 'improper');
          if (correct === 'equal') {
            // åˆ†å­=åˆ†æ¯å±¬æ•´æ•¸ï¼Œä½†åœ¨é€™è£¡ç®—å‡åˆ†æ•¸
            if (choice === 'improper') {
              state.score++;
              feedback.textContent = 'ç­”å°äº†ï¼';
              feedback.className = 'feedback success';
            } else {
              feedback.textContent = 'ç­”æ¡ˆæ˜¯ã€Œå‡åˆ†æ•¸ã€ï¼ˆæˆ–æ•´æ•¸ï¼‰ã€‚';
              feedback.className = 'feedback error';
            }
            state.sessionDetails.push({type:'judge', question: `${q.n}/${q.d}`, user: choice, correct: 'å‡åˆ†æ•¸', ok: choice==='improper'});
          } else {
            if (isCorrect) {
              state.score++;
              feedback.textContent = 'ç­”å°äº†ï¼';
              feedback.className = 'feedback success';
            } else {
              feedback.textContent = `ç­”éŒ¯äº†ï¼Œæ­£ç¢ºæ˜¯ã€Œ${correct === 'proper' ? 'çœŸåˆ†æ•¸' : 'å‡åˆ†æ•¸'}ã€ã€‚`;
              feedback.className = 'feedback error';
            }
            state.sessionDetails.push({type:'judge', question: `${q.n}/${q.d}`, user: choice==='proper'?'çœŸåˆ†æ•¸':'å‡åˆ†æ•¸', correct: correct==='proper'?'çœŸåˆ†æ•¸':'å‡åˆ†æ•¸', ok: isCorrect});
          }
          // ä¸‹ä¸€é¡Œ
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
        btnProper.onclick = () => {
          btnProper.classList.add('selected');
          btnImproper.classList.remove('selected');
        };
        btnImproper.onclick = () => {
          btnImproper.classList.add('selected');
          btnProper.classList.remove('selected');
        };
      } else if (q.type === 'imp2mix') {
        // input for whole, numerator, denominator
        const wInput = document.createElement('input');
        wInput.type = 'number';
        wInput.placeholder = 'æ•´æ•¸';
        wInput.min = 0;
        wInput.style.width = '4rem';
        const nInput = document.createElement('input');
        nInput.type = 'number';
        nInput.placeholder = 'åˆ†å­';
        nInput.min = 0;
        const dInput = document.createElement('input');
        dInput.type = 'number';
        dInput.placeholder = 'åˆ†æ¯';
        dInput.min = 1;
        inputRow.appendChild(wInput);
        inputRow.appendChild(document.createTextNode(' '));
        inputRow.appendChild(nInput);
        inputRow.appendChild(document.createTextNode('/'));
        inputRow.appendChild(dInput);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = 'é€å‡º';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        submitBtn.onclick = () => {
          const W = parseInt(wInput.value, 10);
          const N = parseInt(nInput.value, 10);
          const D = parseInt(dInput.value, 10);
          if (isNaN(W) || isNaN(N) || isNaN(D) || D <= 0) {
            feedback.textContent = 'è«‹è¼¸å…¥å®Œæ•´æ•¸å€¼';
            feedback.className = 'feedback error';
            return;
          }
          const ok = (W === q.whole && N === q.rem && D === q.d);
          if (ok) {
            state.score++;
            feedback.textContent = 'ç­”å°äº†ï¼';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç‚º ${q.whole} ${q.rem}/${q.d}`;
            feedback.className = 'feedback error';
          }
          state.sessionDetails.push({type:'imp2mix', question:`${q.n}/${q.d}`, user: `${W} ${N}/${D}`, correct: `${q.whole} ${q.rem}/${q.d}`, ok: ok});
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
      } else if (q.type === 'mix2imp') {
        // input for new numerator, denominator
        const nInput = document.createElement('input');
        nInput.type = 'number';
        nInput.placeholder = 'åˆ†å­';
        nInput.min = 0;
        const dInput = document.createElement('input');
        dInput.type = 'number';
        dInput.placeholder = 'åˆ†æ¯';
        dInput.min = 1;
        inputRow.appendChild(nInput);
        inputRow.appendChild(document.createTextNode('/'));
        inputRow.appendChild(dInput);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = 'é€å‡º';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        submitBtn.onclick = () => {
          const N = parseInt(nInput.value, 10);
          const D = parseInt(dInput.value, 10);
          if (isNaN(N) || isNaN(D) || D <= 0) {
            feedback.textContent = 'è«‹è¼¸å…¥å®Œæ•´æ•¸å€¼';
            feedback.className = 'feedback error';
            return;
          }
          const ok = (N === q.n && D === q.d);
          if (ok) {
            state.score++;
            feedback.textContent = 'ç­”å°äº†ï¼';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç‚º ${q.n}/${q.d}`;
            feedback.className = 'feedback error';
          }
          state.sessionDetails.push({type:'mix2imp', question:`${q.whole} ${q.nPart}/${q.d}`, user: `${N}/${D}`, correct: `${q.n}/${q.d}`, ok: ok});
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
      } else if (q.type === 'visualMulti') {
        // é¡¯ç¤ºé•·æ¢
        const barsWrap = document.createElement('div');
        barsWrap.className = 'bar-container';
        // compute number of full bars and remainder
        let whole = Math.floor(q.n / q.d);
        let rem = q.n % q.d;
        for (let i=0; i<whole; i++) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          for (let j=0; j<q.d; j++) {
            const cell = document.createElement('div');
            cell.className = 'cell filled';
            bar.appendChild(cell);
          }
          barsWrap.appendChild(bar);
        }
        // remainder bar
        if (rem > 0) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          for (let j=0; j<q.d; j++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            if (j < rem) cell.classList.add('filled');
            bar.appendChild(cell);
          }
          barsWrap.appendChild(bar);
        }
        container.appendChild(barsWrap);
        // è¾“å…¥åˆ†å­
        const nInput = document.createElement('input');
        nInput.type = 'number';
        nInput.placeholder = 'åˆ†å­';
        nInput.min = 0;
        const dInput = document.createElement('input');
        dInput.type = 'number';
        dInput.value = q.d;
        dInput.readOnly = true;
        dInput.style.background = '#f0f0f0';
        inputRow.appendChild(nInput);
        inputRow.appendChild(document.createTextNode('/'));
        inputRow.appendChild(dInput);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = 'é€å‡º';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        submitBtn.onclick = () => {
          const N = parseInt(nInput.value, 10);
          if (isNaN(N)) {
            feedback.textContent = 'è«‹è¼¸å…¥åˆ†å­';
            feedback.className = 'feedback error';
            return;
          }
          const ok = (N === q.n);
          if (ok) {
            state.score++;
            feedback.textContent = 'ç­”å°äº†ï¼';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç‚º ${q.n}/${q.d}`;
            feedback.className = 'feedback error';
          }
          state.sessionDetails.push({type:'visualMulti', question:`${q.n}/${q.d}`, user: `${N}/${q.d}`, correct: `${q.n}/${q.d}`, ok: ok});
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
      } else if (q.type === 'compare') {
        // show three option buttons: > < =
        const btnGT = document.createElement('button');
        btnGT.textContent = '>';
        btnGT.className = 'option';
        const btnEQ = document.createElement('button');
        btnEQ.textContent = '=';
        btnEQ.className = 'option';
        const btnLT = document.createElement('button');
        btnLT.textContent = '<';
        btnLT.className = 'option';
        inputRow.appendChild(btnGT);
        inputRow.appendChild(btnEQ);
        inputRow.appendChild(btnLT);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = 'é€å‡º';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        let choice = null;
        function select(btn, value) {
          btnGT.classList.remove('selected');
          btnEQ.classList.remove('selected');
          btnLT.classList.remove('selected');
          btn.classList.add('selected');
          choice = value;
        }
        btnGT.onclick = () => select(btnGT, '>');
        btnEQ.onclick = () => select(btnEQ, '=');
        btnLT.onclick = () => select(btnLT, '<');
        submitBtn.onclick = () => {
          if (!choice) {
            feedback.textContent = 'è«‹å…ˆé¸æ“‡é—œä¿‚';
            feedback.className = 'feedback error';
            return;
          }
          const ok = (choice === q.correct);
          if (ok) {
            state.score++;
            feedback.textContent = 'ç­”å°äº†ï¼';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç‚º ${q.correct}`;
            feedback.className = 'feedback error';
          }
          state.sessionDetails.push({type:'compare', question:`${q.n1}/${q.d1} ? ${q.n2}/${q.d2}`, user: choice, correct: q.correct, ok: ok});
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
      } else if (q.type === 'numberLine') {
        // ç•«å‡ºæ•¸ç·š
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.classList.add('numberline');
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', '60');
        const width = 600; // intrinsic width for drawing; will scale to 100%
        const height = 60;
        const d = q.d;
        const units = q.units;
        const totalTicks = d * units + 1;
        const startX = 20;
        const endX = width - 20;
        const lineY = 40;
        const step = (endX - startX) / (totalTicks - 1);
        // Draw baseline
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', startX);
        line.setAttribute('y1', lineY);
        line.setAttribute('x2', endX);
        line.setAttribute('y2', lineY);
        line.setAttribute('stroke', '#555');
        line.setAttribute('stroke-width', '2');
        svg.appendChild(line);
        // Draw ticks and labels
        for (let i=0; i<totalTicks; i++) {
          const x = startX + i * step;
          const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          tick.setAttribute('x1', x);
          tick.setAttribute('y1', lineY);
          tick.setAttribute('x2', x);
          tick.setAttribute('y2', lineY - 8);
          tick.setAttribute('stroke', '#555');
          tick.setAttribute('stroke-width', '2');
          svg.appendChild(tick);
          // labels at integers
          if (i % d === 0) {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x);
            text.setAttribute('y', lineY + 15);
            text.setAttribute('font-size', '12');
            text.setAttribute('text-anchor', 'middle');
            text.textContent = i / d;
            svg.appendChild(text);
          }
        }
        // draw point indicator for q.idx
        const px = startX + q.idx * step;
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', px);
        circle.setAttribute('cy', lineY - 12);
        circle.setAttribute('r', '6');
        circle.setAttribute('fill', varColor('primary'));
        svg.appendChild(circle);
        container.appendChild(svg);
        // Input for numerator
        const nInput = document.createElement('input');
        nInput.type = 'number';
        nInput.placeholder = 'åˆ†å­';
        nInput.min = 0;
        const dInput = document.createElement('input');
        dInput.type = 'number';
        dInput.value = q.d;
        dInput.readOnly = true;
        dInput.style.background = '#f0f0f0';
        inputRow.appendChild(nInput);
        inputRow.appendChild(document.createTextNode('/'));
        inputRow.appendChild(dInput);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = 'é€å‡º';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        submitBtn.onclick = () => {
          const N = parseInt(nInput.value, 10);
          if (isNaN(N)) {
            feedback.textContent = 'è«‹è¼¸å…¥åˆ†å­';
            feedback.className = 'feedback error';
            return;
          }
          const ok = (N === q.correct.n);
          if (ok) {
            state.score++;
            feedback.textContent = 'ç­”å°äº†ï¼';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç‚º ${q.correct.n}/${q.correct.d}`;
            feedback.className = 'feedback error';
          }
          state.sessionDetails.push({type:'numberLine', question:`${q.correct.n}/${q.correct.d}`, user: `${N}/${q.correct.d}`, correct: `${q.correct.n}/${q.correct.d}`, ok: ok});
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
      }
      main.appendChild(container);
    }
    // çµæŸæ™‚é¡¯ç¤ºç¸½çµ
    function finishPractice() {
      const main = document.getElementById('main');
      main.innerHTML = '';
      const summary = document.createElement('div');
      summary.innerHTML = `<h2>ä»Šå¤©å®Œæˆï¼</h2><p>ä½ ç­”å°äº† ${state.score} é¡Œï¼Œå…± ${state.questions.length} é¡Œã€‚</p>`;
      // save record
      const now = new Date();
      const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
      saveSessionRecord({ time: timeStr, score: state.score, total: state.questions.length, details: state.sessionDetails });
      // buttons to restart or warmup
      const btnAgain = document.createElement('button');
      btnAgain.className = 'btn';
      btnAgain.textContent = 'å†ç·´ä¸€æ¬¡';
      btnAgain.onclick = () => {
        // start new practice same mode
        state.mode = state.mode; // unchanged
        initPractice(state.mode);
      };
      const btnBack = document.createElement('button');
      btnBack.className = 'btn';
      btnBack.style.marginLeft = '0.5rem';
      btnBack.textContent = 'å›æš–èº«æ•™å­¸';
      btnBack.onclick = () => {
        state.mode = 'warmup';
        renderNav();
        renderWarmup();
      };
      summary.appendChild(btnAgain);
      summary.appendChild(btnBack);
      main.appendChild(summary);
    }
    // é¡è‰²è®Šæ›åŠ©æ‰‹
    function varColor(name) {
      const styles = getComputedStyle(document.documentElement);
      return styles.getPropertyValue(`--${name}`) || '#000';
    }
    // é¡¯ç¤ºç´€éŒ„é¢æ¿
    function showRecordPanel() {
      const records = getSessionRecords();
      const content = document.getElementById('recordContent');
      if (!records.length) {
        content.innerHTML = '<p>å°šç„¡ç´€éŒ„ã€‚</p>';
      } else {
        let html = '<table><tr><th>æ™‚é–“</th><th>å¾—åˆ†</th><th>ç¸½é¡Œæ•¸</th></tr>';
        records.slice().reverse().forEach(rec => {
          html += `<tr><td>${rec.time}</td><td>${rec.score}</td><td>${rec.total}</td></tr>`;
        });
        html += '</table>';
        content.innerHTML = html;
      }
      document.getElementById('recordModal').classList.add('active');
    }
    // åˆå§‹æ¸²æŸ“
    renderNav();
    renderWarmup();
    // ç´€éŒ„æŒ‰éˆ•
    document.getElementById('recordBtn').onclick = showRecordPanel;
    document.getElementById('closeRecord').onclick = () => {
      document.getElementById('recordModal').classList.remove('active');
    };
  })();
  </script>
</body>
</html>