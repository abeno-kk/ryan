<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>三年級｜真分數與假分數練習</title>
  <style>
    /* 基本排版與配色 */
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --gray-100: #f5f5f5;
      --gray-200: #e5e5e5;
      --gray-300: #d4d4d4;
      --gray-700: #374151;
      --gray-900: #111827;
      --success: #10b981;
      --error: #ef4444;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--gray-100);
      color: var(--gray-900);
    }
    .container {
      max-width: 840px;
      margin: 0 auto;
      padding: 1rem;
    }
    h1 {
      font-size: 1.5rem;
      margin: 0.5rem 0 0.25rem;
    }
    h2 {
      font-size: 1.25rem;
      margin: 1rem 0 0.5rem;
    }
    p {
      margin: 0.25rem 0;
      line-height: 1.5;
    }
    .nav {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .nav button {
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      background: white;
      color: var(--gray-900);
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    .nav button:hover {
      background: var(--gray-200);
    }
    .nav button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }
    .modebar {
      margin-bottom: 1rem;
    }
    .question {
      margin-bottom: 1rem;
    }
    .question h3 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    .input-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .input-row input[type="number"], .input-row input[type="text"] {
      width: 4rem;
      padding: 0.4rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      font-size: 1rem;
    }
    .input-row button.option {
      padding: 0.4rem 0.7rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      background: white;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .input-row button.option.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }
    .btn {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover {
      background: var(--primary-dark);
    }
    .feedback {
      margin-top: 0.5rem;
      font-weight: bold;
    }
    .feedback.success {
      color: var(--success);
    }
    .feedback.error {
      color: var(--error);
    }
    /* 視覺化條件格子 */
    .bar-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin: 0.5rem 0;
    }
    .bar {
      display: flex;
      gap: 0.1rem;
    }
    .cell {
      width: 24px;
      height: 24px;
      border: 1px solid var(--gray-300);
      border-radius: 0.125rem;
      background: var(--gray-200);
    }
    .cell.filled {
      background: var(--primary);
    }
    /* number line */
    .numberline {
      margin: 1rem 0;
      width: 100%;
      height: 60px;
    }
    /* 紀錄面板樣式 */
    .record-panel {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 100;
    }
    .record-button {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .record-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .record-modal.active {
      display: flex;
    }
    .record-modal .panel {
      background: white;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      padding: 1rem;
      border-radius: 0.5rem;
    }
    .record-modal .panel h3 {
      margin-top: 0;
    }
    .record-modal table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 0.5rem;
    }
    .record-modal td, .record-modal th {
      border: 1px solid var(--gray-300);
      padding: 0.4rem;
      font-size: 0.85rem;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.25rem; }
      .nav button { font-size: 0.8rem; }
      .input-row input[type="number"], .input-row input[type="text"] { width: 3rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>三年級｜真分數與假分數 練習</h1>
    <p>每天 10 題，題目不重複；先看懂真分數、假分數、帶分數，再開始闖關！</p>
    <div class="nav" id="nav"></div>
    <div id="main"></div>
  </div>
  <!-- 學習紀錄按鈕與彈窗 -->
  <div class="record-panel">
    <button class="record-button" id="recordBtn">📒</button>
  </div>
  <div class="record-modal" id="recordModal">
    <div class="panel">
      <h3>今天的練習紀錄</h3>
      <div id="recordContent"></div>
      <button class="btn" id="closeRecord">關閉</button>
    </div>
  </div>
  <script>
  (function() {
    // 簡易種子亂數生成器 (mulberry32)
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }
    function getTodayStr() {
      const d = new Date();
      const yyyy = d.getFullYear().toString();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return yyyy + mm + dd;
    }
    // 狀態
    const state = {
      mode: 'warmup',
      idx: 0,
      score: 0,
      questions: [],
      rng: null,
      seed: 0,
      attempt: 1,
      logKey: '',
      sessionDetails: []
    };
    // 讀取當天練習次數
    function loadAttempt() {
      const key = 'frac-attempt-' + getTodayStr();
      let num = parseInt(localStorage.getItem(key) || '0', 10);
      return num;
    }
    function saveAttempt(num) {
      const key = 'frac-attempt-' + getTodayStr();
      localStorage.setItem(key, String(num));
    }
    // 儲存完成的練習紀錄
    function saveSessionRecord(record) {
      const logKey = 'frac-log-' + getTodayStr();
      let list = [];
      try { list = JSON.parse(localStorage.getItem(logKey) || '[]'); } catch(err) {}
      list.push(record);
      localStorage.setItem(logKey, JSON.stringify(list));
    }
    // 取得紀錄
    function getSessionRecords() {
      const logKey = 'frac-log-' + getTodayStr();
      try { return JSON.parse(localStorage.getItem(logKey) || '[]'); } catch(err) { return []; }
    }
    // 產生基礎題庫
    function generateBasicQuestions(count) {
      const qs = [];
      const categories = ['judge','imp2mix','mix2imp'];
      for (let i=0; i<count; i++) {
        const type = categories[i % categories.length];
        if (type === 'judge') {
          // 分子1-15，分母6-12
          let d = Math.floor(state.rng()*7) + 6; // 6-12
          let n = Math.floor(state.rng()*20) + 1; // 1-20
          // avoid n and d multiples for too trivial; but allow mixture
          qs.push({type:'judge', n: n, d: d, correct: (n < d) ? 'proper' : (n === d ? 'equal' : 'improper')});
        } else if (type === 'imp2mix') {
          let d = Math.floor(state.rng()*7) + 4; // 4-10
          let whole = Math.floor(state.rng()*4) + 2; // 2-5
          let rem = Math.floor(state.rng()*d) + 1; // 1-d
          let n = whole * d + rem;
          qs.push({type:'imp2mix', n: n, d: d, whole: whole, rem: rem});
        } else if (type === 'mix2imp') {
          let d = Math.floor(state.rng()*7) + 3; // 3-9
          let whole = Math.floor(state.rng()*4) + 2; // 2-5
          let rem = Math.floor(state.rng()*(d-1)) + 1; // 1 to d-1
          let n = whole * d + rem;
          qs.push({type:'mix2imp', whole: whole, nPart: rem, d: d, n: n});
        }
      }
      // 洗牌
      for (let i=qs.length-1; i>0; i--) {
        const j = Math.floor(state.rng() * (i+1));
        [qs[i], qs[j]] = [qs[j], qs[i]];
      }
      return qs;
    }
    // 產生進階題庫
    function generateAdvancedQuestions(count) {
      const qs = [];
      const categories = ['visualMulti','compare','numberLine'];
      for (let i=0; i<count; i++) {
        const type = categories[i % categories.length];
        if (type === 'visualMulti') {
          // 多條分數長條顯示，分母5-12；分子 1 - denom*3
          let d = Math.floor(state.rng()*8) + 5; // 5-12
          let max = d * (Math.floor(state.rng()*2)+2); // 2或3個長條
          let n = Math.floor(state.rng()*max) + 1;
          // 確保不為0
          qs.push({type:'visualMulti', n: n, d: d});
        } else if (type === 'compare') {
          let d1 = Math.floor(state.rng()*9) + 3; // 3-11
          let d2 = Math.floor(state.rng()*9) + 3;
          let n1 = Math.floor(state.rng()*d1*2) + 1;
          let n2 = Math.floor(state.rng()*d2*2) + 1;
          // avoid trivial equal but may appear seldom; we allow equals for challenge
          // Determine correct
          let v1 = n1 / d1;
          let v2 = n2 / d2;
          let sign;
          if (Math.abs(v1 - v2) < 1e-9) sign = '=';
          else sign = v1 > v2 ? '>' : '<';
          qs.push({type:'compare', n1: n1, d1: d1, n2: n2, d2: d2, correct: sign});
        } else if (type === 'numberLine') {
          // number line from 0 to units (1 or 2 or 3). Denominator2-6
          let units = Math.floor(state.rng()*2) + 1; // 1-2
          let d = Math.floor(state.rng()*5) + 2; // 2-6
          let totalTicks = d * units + 1;
          let idx = Math.floor(state.rng()*(totalTicks-2)) + 1; // not first or last
          // compute improper fraction representation numerator
          let n = idx;
          let correct = {n:n, d:d};
          qs.push({type:'numberLine', units: units, d: d, idx: idx, correct: correct});
        }
      }
      // shuffle
      for (let i=qs.length-1; i>0; i--) {
        const j = Math.floor(state.rng() * (i+1));
        [qs[i], qs[j]] = [qs[j], qs[i]];
      }
      return qs;
    }
    // 渲染導航按鈕
    function renderNav() {
      const nav = document.getElementById('nav');
      nav.innerHTML = '';
      const modes = [
        {id:'warmup', label:'暖身教學'},
        {id:'basic', label:'基本練習'},
        {id:'advanced', label:'進階練習'},
      ];
      modes.forEach(m => {
        const btn = document.createElement('button');
        btn.textContent = m.label;
        btn.dataset.mode = m.id;
        if (state.mode === m.id) btn.classList.add('active');
        btn.addEventListener('click', () => {
          if (m.id === 'warmup') {
            state.mode = 'warmup';
            renderNav();
            renderWarmup();
          } else if (m.id === 'basic') {
            state.mode = 'basic';
            initPractice('basic');
          } else if (m.id === 'advanced') {
            state.mode = 'advanced';
            initPractice('advanced');
          }
        });
        nav.appendChild(btn);
      });
    }
    // 渲染暖身教學頁
    function renderWarmup() {
      const main = document.getElementById('main');
      main.innerHTML = '';
      const div = document.createElement('div');
      div.innerHTML = `
        <h2>暖身教學</h2>
        <p>先看懂一個例子，再開始練習！</p>
        <div style="border:1px solid var(--gray-300); border-radius:0.5rem; padding:1rem; margin-bottom:1rem;">
          <h3>什麼是真分數？</h3>
          <p>把一個圓平均分成 <b>5 等份</b>（分母），塗上 <b>3 份</b>（分子），寫成分數：<b>3/5</b>。因為 <b>3 &lt; 5</b>，所以是 <span style="color:var(--success); font-weight:bold;">真分數</span>。</p>
          <div class="bar-container"></div>
        </div>
        <div style="border:1px solid var(--gray-300); border-radius:0.5rem; padding:1rem;">
          <h3>什麼是假分數？什麼是帶分數？</h3>
          <p>假分數的分子比分母大。例如分數 <b>13/5</b> 可以換成帶分數 <b>2 又 3/5</b>，因為 <b>13 ÷ 5 = 2</b> 餘 <b>3</b>。</p>
        </div>
        <button class="btn" id="startPractice">開始練習！</button>
      `;
      main.appendChild(div);
      // 填充示意圖
      const barCtn = div.querySelector('.bar-container');
      // 繪製 5 等分長條，塗 3 格
      const bar = document.createElement('div');
      bar.className = 'bar';
      for (let i=0; i<5; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        if (i<3) cell.classList.add('filled');
        bar.appendChild(cell);
      }
      barCtn.appendChild(bar);
      // Start button
      div.querySelector('#startPractice').onclick = () => {
        state.mode = 'basic';
        initPractice('basic');
      };
    }
    // 初始化練習
    function initPractice(mode) {
      // 更新導航
      renderNav();
      // 產生種子與嘗試次數
      let attempt = loadAttempt() + 1;
      saveAttempt(attempt);
      state.attempt = attempt;
      const seedStr = getTodayStr() + attempt;
      let seedInt = 0;
      for (let i=0; i<seedStr.length; i++) {
        seedInt = (seedInt * 31 + seedStr.charCodeAt(i)) >>> 0;
      }
      state.seed = seedInt;
      state.rng = mulberry32(seedInt);
      state.idx = 0;
      state.score = 0;
      state.sessionDetails = [];
      state.mode = mode;
      // 產生題庫
      const count = 10;
      if (mode === 'basic') {
        state.questions = generateBasicQuestions(count);
      } else {
        state.questions = generateAdvancedQuestions(count);
      }
      // 設定當前記錄鍵
      state.logKey = 'frac-log-' + getTodayStr();
      renderCurrentQuestion();
    }
    // 渲染當前題目
    function renderCurrentQuestion() {
      const main = document.getElementById('main');
      main.innerHTML = '';
      const idx = state.idx;
      if (idx >= state.questions.length) {
        // 結束
        finishPractice();
        return;
      }
      const q = state.questions[idx];
      const container = document.createElement('div');
      container.className = 'question';
      // 標題
      const title = document.createElement('h3');
      let titleTxt = '';
      if (q.type === 'judge') {
        titleTxt = `判斷： ${q.n}/${q.d}`;
      } else if (q.type === 'imp2mix') {
        titleTxt = `將 ${q.n}/${q.d} 轉換為帶分數`;
      } else if (q.type === 'mix2imp') {
        titleTxt = `將 ${q.whole} ${q.nPart}/${q.d} 轉換成假分數`;
      } else if (q.type === 'visualMulti') {
        titleTxt = `看圖寫出分數 (分母 ${q.d})`;
      } else if (q.type === 'compare') {
        titleTxt = `比較大小： ${q.n1}/${q.d1}  ?  ${q.n2}/${q.d2}`;
      } else if (q.type === 'numberLine') {
        titleTxt = `數線填空：請填入紅點所代表的分數`;
      }
      title.textContent = titleTxt;
      container.appendChild(title);
      // 輔助說明
      let hint = '';
      if (q.type === 'judge') {
        hint = '題目說明：請從下面選擇「真分數」或「假分數」。';
      } else if (q.type === 'imp2mix') {
        hint = '題目說明：請輸入「整數、分子、分母」，再按送出。';
      } else if (q.type === 'mix2imp') {
        hint = '題目說明：請輸入新的「分子、分母」，再按送出。';
      } else if (q.type === 'visualMulti') {
        hint = '題目說明：請看圖輸入藍色格子總數作為「分子」，分母已固定為 ' + q.d + '，再按送出。';
      } else if (q.type === 'compare') {
        hint = '題目說明：請選擇「>」「<」或「=」。';
      } else if (q.type === 'numberLine') {
        hint = '題目說明：請輸入紅點對應的「分子」，分母為 ' + q.d + '；如果分子大於等於分母代表超過 1。';
      }
      const hintP = document.createElement('p');
      hintP.style.background = 'var(--gray-200)';
      hintP.style.padding = '0.5rem';
      hintP.style.borderRadius = '0.375rem';
      hintP.style.marginBottom = '0.5rem';
      hintP.textContent = hint;
      container.appendChild(hintP);
      // 題目內容（輸入區）
      const inputRow = document.createElement('div');
      inputRow.className = 'input-row';
      // feedback
      const feedback = document.createElement('div');
      feedback.className = 'feedback';
      container.appendChild(inputRow);
      if (q.type === 'judge') {
        // two buttons
        const btnProper = document.createElement('button');
        btnProper.textContent = '真分數';
        btnProper.className = 'option';
        const btnImproper = document.createElement('button');
        btnImproper.textContent = '假分數';
        btnImproper.className = 'option';
        inputRow.appendChild(btnProper);
        inputRow.appendChild(btnImproper);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = '送出';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        submitBtn.onclick = () => {
          // determine selection
          let choice = null;
          if (btnProper.classList.contains('selected')) choice = 'proper';
          else if (btnImproper.classList.contains('selected')) choice = 'improper';
          if (!choice) {
            feedback.textContent = '請先選擇答案';
            feedback.className = 'feedback error';
            return;
          }
          const correct = q.correct;
          const isCorrect = (correct === 'proper' && choice === 'proper') || (correct === 'improper' && choice === 'improper');
          if (correct === 'equal') {
            // 分子=分母屬整數，但在這裡算假分數
            if (choice === 'improper') {
              state.score++;
              feedback.textContent = '答對了！';
              feedback.className = 'feedback success';
            } else {
              feedback.textContent = '答案是「假分數」（或整數）。';
              feedback.className = 'feedback error';
            }
            state.sessionDetails.push({type:'judge', question: `${q.n}/${q.d}`, user: choice, correct: '假分數', ok: choice==='improper'});
          } else {
            if (isCorrect) {
              state.score++;
              feedback.textContent = '答對了！';
              feedback.className = 'feedback success';
            } else {
              feedback.textContent = `答錯了，正確是「${correct === 'proper' ? '真分數' : '假分數'}」。`;
              feedback.className = 'feedback error';
            }
            state.sessionDetails.push({type:'judge', question: `${q.n}/${q.d}`, user: choice==='proper'?'真分數':'假分數', correct: correct==='proper'?'真分數':'假分數', ok: isCorrect});
          }
          // 下一題
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
        btnProper.onclick = () => {
          btnProper.classList.add('selected');
          btnImproper.classList.remove('selected');
        };
        btnImproper.onclick = () => {
          btnImproper.classList.add('selected');
          btnProper.classList.remove('selected');
        };
      } else if (q.type === 'imp2mix') {
        // input for whole, numerator, denominator
        const wInput = document.createElement('input');
        wInput.type = 'number';
        wInput.placeholder = '整數';
        wInput.min = 0;
        wInput.style.width = '4rem';
        const nInput = document.createElement('input');
        nInput.type = 'number';
        nInput.placeholder = '分子';
        nInput.min = 0;
        const dInput = document.createElement('input');
        dInput.type = 'number';
        dInput.placeholder = '分母';
        dInput.min = 1;
        inputRow.appendChild(wInput);
        inputRow.appendChild(document.createTextNode(' '));
        inputRow.appendChild(nInput);
        inputRow.appendChild(document.createTextNode('/'));
        inputRow.appendChild(dInput);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = '送出';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        submitBtn.onclick = () => {
          const W = parseInt(wInput.value, 10);
          const N = parseInt(nInput.value, 10);
          const D = parseInt(dInput.value, 10);
          if (isNaN(W) || isNaN(N) || isNaN(D) || D <= 0) {
            feedback.textContent = '請輸入完整數值';
            feedback.className = 'feedback error';
            return;
          }
          const ok = (W === q.whole && N === q.rem && D === q.d);
          if (ok) {
            state.score++;
            feedback.textContent = '答對了！';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `答錯了，正確為 ${q.whole} ${q.rem}/${q.d}`;
            feedback.className = 'feedback error';
          }
          state.sessionDetails.push({type:'imp2mix', question:`${q.n}/${q.d}`, user: `${W} ${N}/${D}`, correct: `${q.whole} ${q.rem}/${q.d}`, ok: ok});
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
      } else if (q.type === 'mix2imp') {
        // input for new numerator, denominator
        const nInput = document.createElement('input');
        nInput.type = 'number';
        nInput.placeholder = '分子';
        nInput.min = 0;
        const dInput = document.createElement('input');
        dInput.type = 'number';
        dInput.placeholder = '分母';
        dInput.min = 1;
        inputRow.appendChild(nInput);
        inputRow.appendChild(document.createTextNode('/'));
        inputRow.appendChild(dInput);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = '送出';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        submitBtn.onclick = () => {
          const N = parseInt(nInput.value, 10);
          const D = parseInt(dInput.value, 10);
          if (isNaN(N) || isNaN(D) || D <= 0) {
            feedback.textContent = '請輸入完整數值';
            feedback.className = 'feedback error';
            return;
          }
          const ok = (N === q.n && D === q.d);
          if (ok) {
            state.score++;
            feedback.textContent = '答對了！';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `答錯了，正確為 ${q.n}/${q.d}`;
            feedback.className = 'feedback error';
          }
          state.sessionDetails.push({type:'mix2imp', question:`${q.whole} ${q.nPart}/${q.d}`, user: `${N}/${D}`, correct: `${q.n}/${q.d}`, ok: ok});
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
      } else if (q.type === 'visualMulti') {
        // 顯示長條
        const barsWrap = document.createElement('div');
        barsWrap.className = 'bar-container';
        // compute number of full bars and remainder
        let whole = Math.floor(q.n / q.d);
        let rem = q.n % q.d;
        for (let i=0; i<whole; i++) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          for (let j=0; j<q.d; j++) {
            const cell = document.createElement('div');
            cell.className = 'cell filled';
            bar.appendChild(cell);
          }
          barsWrap.appendChild(bar);
        }
        // remainder bar
        if (rem > 0) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          for (let j=0; j<q.d; j++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            if (j < rem) cell.classList.add('filled');
            bar.appendChild(cell);
          }
          barsWrap.appendChild(bar);
        }
        container.appendChild(barsWrap);
        // 输入分子
        const nInput = document.createElement('input');
        nInput.type = 'number';
        nInput.placeholder = '分子';
        nInput.min = 0;
        const dInput = document.createElement('input');
        dInput.type = 'number';
        dInput.value = q.d;
        dInput.readOnly = true;
        dInput.style.background = '#f0f0f0';
        inputRow.appendChild(nInput);
        inputRow.appendChild(document.createTextNode('/'));
        inputRow.appendChild(dInput);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = '送出';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        submitBtn.onclick = () => {
          const N = parseInt(nInput.value, 10);
          if (isNaN(N)) {
            feedback.textContent = '請輸入分子';
            feedback.className = 'feedback error';
            return;
          }
          const ok = (N === q.n);
          if (ok) {
            state.score++;
            feedback.textContent = '答對了！';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `答錯了，正確為 ${q.n}/${q.d}`;
            feedback.className = 'feedback error';
          }
          state.sessionDetails.push({type:'visualMulti', question:`${q.n}/${q.d}`, user: `${N}/${q.d}`, correct: `${q.n}/${q.d}`, ok: ok});
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
      } else if (q.type === 'compare') {
        // show three option buttons: > < =
        const btnGT = document.createElement('button');
        btnGT.textContent = '>';
        btnGT.className = 'option';
        const btnEQ = document.createElement('button');
        btnEQ.textContent = '=';
        btnEQ.className = 'option';
        const btnLT = document.createElement('button');
        btnLT.textContent = '<';
        btnLT.className = 'option';
        inputRow.appendChild(btnGT);
        inputRow.appendChild(btnEQ);
        inputRow.appendChild(btnLT);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = '送出';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        let choice = null;
        function select(btn, value) {
          btnGT.classList.remove('selected');
          btnEQ.classList.remove('selected');
          btnLT.classList.remove('selected');
          btn.classList.add('selected');
          choice = value;
        }
        btnGT.onclick = () => select(btnGT, '>');
        btnEQ.onclick = () => select(btnEQ, '=');
        btnLT.onclick = () => select(btnLT, '<');
        submitBtn.onclick = () => {
          if (!choice) {
            feedback.textContent = '請先選擇關係';
            feedback.className = 'feedback error';
            return;
          }
          const ok = (choice === q.correct);
          if (ok) {
            state.score++;
            feedback.textContent = '答對了！';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `答錯了，正確為 ${q.correct}`;
            feedback.className = 'feedback error';
          }
          state.sessionDetails.push({type:'compare', question:`${q.n1}/${q.d1} ? ${q.n2}/${q.d2}`, user: choice, correct: q.correct, ok: ok});
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
      } else if (q.type === 'numberLine') {
        // 畫出數線
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.classList.add('numberline');
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', '60');
        const width = 600; // intrinsic width for drawing; will scale to 100%
        const height = 60;
        const d = q.d;
        const units = q.units;
        const totalTicks = d * units + 1;
        const startX = 20;
        const endX = width - 20;
        const lineY = 40;
        const step = (endX - startX) / (totalTicks - 1);
        // Draw baseline
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', startX);
        line.setAttribute('y1', lineY);
        line.setAttribute('x2', endX);
        line.setAttribute('y2', lineY);
        line.setAttribute('stroke', '#555');
        line.setAttribute('stroke-width', '2');
        svg.appendChild(line);
        // Draw ticks and labels
        for (let i=0; i<totalTicks; i++) {
          const x = startX + i * step;
          const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          tick.setAttribute('x1', x);
          tick.setAttribute('y1', lineY);
          tick.setAttribute('x2', x);
          tick.setAttribute('y2', lineY - 8);
          tick.setAttribute('stroke', '#555');
          tick.setAttribute('stroke-width', '2');
          svg.appendChild(tick);
          // labels at integers
          if (i % d === 0) {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x);
            text.setAttribute('y', lineY + 15);
            text.setAttribute('font-size', '12');
            text.setAttribute('text-anchor', 'middle');
            text.textContent = i / d;
            svg.appendChild(text);
          }
        }
        // draw point indicator for q.idx
        const px = startX + q.idx * step;
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', px);
        circle.setAttribute('cy', lineY - 12);
        circle.setAttribute('r', '6');
        circle.setAttribute('fill', varColor('primary'));
        svg.appendChild(circle);
        container.appendChild(svg);
        // Input for numerator
        const nInput = document.createElement('input');
        nInput.type = 'number';
        nInput.placeholder = '分子';
        nInput.min = 0;
        const dInput = document.createElement('input');
        dInput.type = 'number';
        dInput.value = q.d;
        dInput.readOnly = true;
        dInput.style.background = '#f0f0f0';
        inputRow.appendChild(nInput);
        inputRow.appendChild(document.createTextNode('/'));
        inputRow.appendChild(dInput);
        const submitBtn = document.createElement('button');
        submitBtn.textContent = '送出';
        submitBtn.className = 'btn';
        container.appendChild(submitBtn);
        container.appendChild(feedback);
        submitBtn.onclick = () => {
          const N = parseInt(nInput.value, 10);
          if (isNaN(N)) {
            feedback.textContent = '請輸入分子';
            feedback.className = 'feedback error';
            return;
          }
          const ok = (N === q.correct.n);
          if (ok) {
            state.score++;
            feedback.textContent = '答對了！';
            feedback.className = 'feedback success';
          } else {
            feedback.textContent = `答錯了，正確為 ${q.correct.n}/${q.correct.d}`;
            feedback.className = 'feedback error';
          }
          state.sessionDetails.push({type:'numberLine', question:`${q.correct.n}/${q.correct.d}`, user: `${N}/${q.correct.d}`, correct: `${q.correct.n}/${q.correct.d}`, ok: ok});
          setTimeout(() => { state.idx++; renderCurrentQuestion(); }, 900);
        };
      }
      main.appendChild(container);
    }
    // 結束時顯示總結
    function finishPractice() {
      const main = document.getElementById('main');
      main.innerHTML = '';
      const summary = document.createElement('div');
      summary.innerHTML = `<h2>今天完成！</h2><p>你答對了 ${state.score} 題，共 ${state.questions.length} 題。</p>`;
      // save record
      const now = new Date();
      const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
      saveSessionRecord({ time: timeStr, score: state.score, total: state.questions.length, details: state.sessionDetails });
      // buttons to restart or warmup
      const btnAgain = document.createElement('button');
      btnAgain.className = 'btn';
      btnAgain.textContent = '再練一次';
      btnAgain.onclick = () => {
        // start new practice same mode
        state.mode = state.mode; // unchanged
        initPractice(state.mode);
      };
      const btnBack = document.createElement('button');
      btnBack.className = 'btn';
      btnBack.style.marginLeft = '0.5rem';
      btnBack.textContent = '回暖身教學';
      btnBack.onclick = () => {
        state.mode = 'warmup';
        renderNav();
        renderWarmup();
      };
      summary.appendChild(btnAgain);
      summary.appendChild(btnBack);
      main.appendChild(summary);
    }
    // 顏色變換助手
    function varColor(name) {
      const styles = getComputedStyle(document.documentElement);
      return styles.getPropertyValue(`--${name}`) || '#000';
    }
    // 顯示紀錄面板
    function showRecordPanel() {
      const records = getSessionRecords();
      const content = document.getElementById('recordContent');
      if (!records.length) {
        content.innerHTML = '<p>尚無紀錄。</p>';
      } else {
        let html = '<table><tr><th>時間</th><th>得分</th><th>總題數</th></tr>';
        records.slice().reverse().forEach(rec => {
          html += `<tr><td>${rec.time}</td><td>${rec.score}</td><td>${rec.total}</td></tr>`;
        });
        html += '</table>';
        content.innerHTML = html;
      }
      document.getElementById('recordModal').classList.add('active');
    }
    // 初始渲染
    renderNav();
    renderWarmup();
    // 紀錄按鈕
    document.getElementById('recordBtn').onclick = showRecordPanel;
    document.getElementById('closeRecord').onclick = () => {
      document.getElementById('recordModal').classList.remove('active');
    };
  })();
  </script>
</body>
</html>